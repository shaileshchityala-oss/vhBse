Imports System
Imports System.Data
Imports System.Data.OleDb
Imports System.Configuration
Imports System.Text
Imports VolHedge.DAL
Imports VolHedge.OptionG
Public Class analysisprocess
#Region "Variable"
    Dim dtable As New DataTable
    Dim pmaintable As New DataTable
    Dim eqtable As New DataTable

    Dim objTrad As New trading
    Dim objBhav As New bhav_copy
    'Dim mObjData As New DataAnalysis.AnalysisData


    Dim scripttable As New DataTable
    Dim eqsecurity As New DataTable
    Dim CurrScript As New DataTable
    'Dim dtanalysis As New DataTable
    'Dim bhavcopy As New DataTable
    'Dim comp_ana As New DataTable
    Dim Mrateofinterast As Double = 0

#End Region
#Region "SP"


    Private Const SP_insert_analysis As String = "insert_analysis"
    Private Const SP_delete_analysis As String = "delete_analysis"
    Private Const SP_delete_analysis_script_company As String = "delete_analysis_script"
    Private Const SP_select_analysis As String = "select_analysis"
    'NoUSE REM:Comment by payal(11-3-2016)
    'Private Const SP_select_analysis_maintable As String = "select_analysis_maintable"
    Private Const sp_update_liq As String = "update_analysis_isliq"
    Private Const sp_update_remarks As String = "update_analysis_remarks"
    Private Const sp_update_IsCalc As String = "update_analysis_IsCalc"
    Private Const sp_update_PreDate As String = "update_analysis_PreData"
    Private Const sp_update_IsVolFix As String = "update_analysis_IsVolFix"

    '==========================keval(17-2-10)--NoUSE REM:payal(11-3-2016)
    'Private Const SP_select_assetToken As String = "select_assetToken"
    '=========================

#End Region
#Region "Method"

    Private Sub init_table()

        dtable = New DataTable
        With dtable.Columns
            .Add("strikes", GetType(Double))
            .Add("cp")
            .Add("prqty", GetType(Double))
            .Add("toqty", GetType(Double))
            .Add("units", GetType(Double))
            .Add("lots", GetType(Double))
            .Add("traded", GetType(Double))
            .Add("last", GetType(Double))
            .Add("lv", GetType(Double))
            .Add("Timevalue", GetType(Double))
            .Add("MktVol", GetType(Double))
            .Add("company")
            .Add("mdate", GetType(Date))
            .Add("fut_mdate", GetType(Date))
            .Add("tokanno", GetType(Long))
            .Add("asset_tokan", GetType(Long))
            .Add("entrydate", GetType(Date))
            .Add("script")
            .Add("isliq", GetType(Boolean))
            .Add("token1", GetType(Long))
            .Add("ftoken", GetType(Long))
            .Add("status")
            .Add("last1", GetType(Double))
            .Add("lv1", GetType(Double))
            .Add("prExp", GetType(Double))
            .Add("toExp", GetType(Double))
            .Add("totExp", GetType(Double))
            .Add("remarks")
            .Add("IsVolFix", GetType(Boolean))
            .Add("IsCalc", GetType(Boolean))

            .Add("preQty", GetType(Double))
            .Add("preDate", GetType(Date))
            .Add("preSpot", GetType(Double))
            .Add("preVol", GetType(Double))
            .Add("preDelVal", GetType(Double))
            .Add("preVegVal", GetType(Double))
            .Add("preTheVal", GetType(Double))

            .Add("curSpot", GetType(Double))
            .Add("curVol", GetType(Double))
            .Add("curDelVal", GetType(Double))
            .Add("curVegVal", GetType(Double))
            .Add("curTheVal", GetType(Double))

            .Add("preTotalMTM", GetType(Double))
            .Add("preGrossMTM", GetType(Double))
            .Add("curTotalMTM", GetType(Double))
            .Add("curGrossMTM", GetType(Double))

            .Add("DeltaN", GetType(Double))
            .Add("GammaN", GetType(Double))
            .Add("VegaN", GetType(Double))
            .Add("ThetaN", GetType(Double))
            .Add("VolgaN", GetType(Double))
            .Add("VannaN", GetType(Double))
            .Add("flast", GetType(Double))
            .Add("Synfut", GetType(Double))
        End With
        pmaintable = dtable.Clone
        eqtable = New DataTable
        With eqtable
            .Columns.Add("script")
            .Columns.Add("company")
            .Columns.Add("eq")
            .Columns.Add("prqty", GetType(Double))
            .Columns.Add("toqty", GetType(Double))
            .Columns.Add("qty", GetType(Double))
            .Columns.Add("rate", GetType(Double))
            .Columns.Add("entrydate", GetType(Date))
            .Columns.Add("entryno", GetType(Double))
            .Columns.Add("uid", GetType(Double))
            .Columns.Add("tokanno")
            .Columns.Add("pratp", GetType(Double))
            .Columns.Add("toatp", GetType(Double))
            .Columns.Add("prExp", GetType(Double))
            .Columns.Add("toExp", GetType(Double))
            .Columns.Add("totExp", GetType(Double))

        End With
    End Sub

    Private Sub update_maintable(ByVal dtTemp As DataTable, ByVal type As String)
        Dim newPos As Boolean
        Dim dr As DataRow
        Dim prExp, toExp As Double
        For Each drow As DataRow In dtTemp.Rows
            newPos = True
            For Each mrow As DataRow In maintable.Select("script = '" & drow("script") & "' And company='" & drow("company") & "'")
                newPos = False
                mrow("prqty") = Val(mrow("prqty").ToString) + Val(drow("prqty").ToString)
                mrow("toqty") = Val(mrow("toqty").ToString) + Val(drow("toqty").ToString)
                Dim currQty As Double = mrow("units")
                prExp = 0
                toExp = 0
                If type = "FO" Then
                    mrow("units") += Val(drow("units"))
                    Call cal_position_expense(mrow, prExp, toExp, "FO")
                    If CLng(mrow("units")) <> 0 Then
                        mrow("traded") = ((mrow("traded") * currQty) + (drow("traded") * drow("units"))) / mrow("units")
                    Else
                        mrow("traded") = mrow("traded") + drow("traded")
                    End If
                    ''divyesh
                ElseIf type = "CURR" Then
                    mrow("units") += Val(drow("units"))
                    Call cal_position_expense(mrow, prExp, toExp, "CURR")
                    If CLng(mrow("units")) <> 0 Then
                        mrow("traded") = ((mrow("traded") * currQty) + (drow("traded") * drow("units"))) / mrow("units")
                    Else
                        mrow("traded") = mrow("traded") + drow("traded")
                    End If
                Else 'for equity
                    mrow("units") += Val(drow("qty"))
                    Call cal_position_expense(mrow, prExp, toExp, "EQ")
                    If CLng(mrow("units")) <> 0 Then
                        mrow("traded") = ((mrow("traded") * currQty) + (drow("rate") * drow("qty"))) / mrow("units")
                    Else
                        mrow("traded") = ((mrow("traded") * currQty) + (drow("rate") * drow("qty"))) 'mrow("traded") + drow("rate")
                    End If
                End If

                ' mrow("traded") = Math.Round(Val(drow("rate")), 2)

                mrow("entrydate") = Today
                mrow("deltaval") = mrow("units")
                mrow("deltaval1") = mrow("units")

                mrow("prExp") = prExp
                mrow("toExp") = toExp
                mrow("totExp") = -(prExp + toExp)
            Next

            If newPos = True Then
                dr = maintable.NewRow()
                dr("company") = drow("company")
                dr("script") = drow("script")

                dr("entrydate") = drow("entrydate")

                dr("isliq") = False
                dr("tokanno") = drow("tokanno")


                dr("prqty") = drow("prqty")
                dr("toqty") = drow("toqty")

                ' Math.Round(Val(drow("traded")), 5)

                If type = "FO" Then
                    dr("traded") = Val(drow("traded").ToString)
                    dr("units") = Val(drow("units"))
                    dr("strikes") = Val(drow("strikes"))
                    dr("cp") = drow("cp")
                    dr("mdate") = drow("mdate")
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("fut_mdate") = drow("fut_mdate")
                    dr("month") = Format(CDate(drow("mdate")), "MMM yy")
                    dr("ftoken") = drow("ftoken")
                    dr("token1") = drow("token1")
                    prExp = 0
                    toExp = 0
                    Call cal_position_expense(dr, prExp, toExp, "FO")
                ElseIf type = "EQ" Then
                    dr("traded") = Val(drow("rate").ToString)
                    dr("units") = Val(drow("qty"))
                    dr("strikes") = 0
                    dr("cp") = "E" 'drow("eq")
                    dr("mdate") = Today
                    If cpfmaster.Select("Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'").Length > 0 Then
                        dr("fut_mdate") = cpfmaster.Compute("MIN(expDate1)", "Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'")
                        dr("ftoken") = cpfmaster.Compute("MAX(token)", "Symbol='" & GetSymbol(drow("company")) & "' AND expdate1=#" & Format(dr("fut_mdate"), "dd-MMM-yyyy") & "# AND option_type='XX'")
                    Else
                        dr("fut_mdate") = Today
                        dr("ftoken") = 0
                    End If
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("asset_tokan") = 0
                    dr("token1") = 0
                    prExp = 0
                    toExp = 0
                    Call cal_position_expense(dr, prExp, toExp, "EQ")
                    ''divyesh
                ElseIf type = "CURR" Then ''for currency
                    dr("traded") = Val(drow("traded").ToString)
                    dr("units") = Val(drow("units"))
                    dr("strikes") = Val(drow("strikes"))
                    dr("cp") = drow("cp")
                    dr("mdate") = drow("mdate")
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("fut_mdate") = drow("fut_mdate")
                    dr("month") = Format(CDate(drow("mdate")), "MMM yy")
                    dr("ftoken") = drow("ftoken")
                    dr("token1") = drow("token1")
                    prExp = 0
                    toExp = 0
                    Call cal_position_expense(dr, prExp, toExp, "CURR")
                End If

                If GdtCurrencyTrades.Select("Script='" & drow("script") & "' And company='" & drow("company") & "'").Length > 0 Then
                    dr("IsCurrency") = True
                Else
                    dr("IsCurrency") = False
                End If
                dr("status") = 1
                dr("last") = 0
                dr("flast") = 0
                dr("last1") = 0
                dr("lv") = 0
                dr("MktVol") = 0
                dr("lv1") = 0
                dr("delta") = 1
                dr("deltaval") = Val(dr("units"))
                dr("theta") = 0
                dr("thetaval") = 0
                dr("vega") = 0
                dr("vgval") = 0
                dr("gamma") = 0
                dr("gmval") = 0
                dr("toatp") = 0
                dr("pratp") = 0
                dr("deltaval1") = Val(dr("units"))
                dr("thetaval1") = 0
                dr("vgval1") = 0
                dr("gmval1") = 0
                dr("volgaval1") = 0
                dr("vannaval1") = 0
                If dr("mdate") = Today.Date And dr("cp") <> "E" Then
                    dr("deltaval1") = 0
                    dr("thetaval1") = 0
                    dr("vgval1") = 0
                    dr("gmval1") = 0
                    dr("volgaval1") = 0
                    dr("vannaval1") = 0
                End If
                dr("mdate_months") = (CDate(Format(CDate(dr("mdate")), "MMM/dd/yyyy")).Year * 12) + (CDate(Format(CDate(dr("mdate")), "MMM/dd/yyyy")).Month)
                dr("prExp") = prExp
                dr("toExp") = toExp
                dr("totExp") = -(prExp + toExp)
                Dim Intrinsivval As Double
                Intrinsivval = getIntrinsivval(CLng(dr("ftoken")), dr("CP"), dr("strikes"))
                drow("Timevalue") = (Val(dr("Last")) - Intrinsivval) * dr("Units") * (-1)
                'If fltpprice.Contains(CLng(drow("ftoken"))) Then   'select LTP from fltpprice hashtable      

                '    Dim fltppr As Double = Val(fltpprice(CLng(drow("ftoken"))))

                '    drow("Synfut") = get_SFut(drow("company"), CDate(drow("mdate")), Convert.ToDouble(fltppr))
                'Else
                '    drow("Synfut") = 0
                'End If
                maintable.Rows.Add(dr)
            End If
        Next

        If maintable.Rows.Count > 0 Then
            If maintable.Compute("count(tokanno)", "last=0") > 0 Then
                dtanalysisData = sel_analysis()
                get_ltp(maintable)
            End If
        End If
        insert_analysis(maintable)
    End Sub

    ''' <summary>
    ''' Used in Process_data While Calculate data after perform DeleteData
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub fill_table()
        Try
            Dim dr As DataRow
            Dim count As Integer
            Dim ar As New ArrayList
            Dim table As New DataTable
            'table = New DataTable

            objTrad.Trading(GdtFOTrades)

            table = GdtFOTrades 'objTrad.Trading
           
            scripttable = cpfmaster

            Dim prExp, toExp As Double
            For Each drow As DataRow In table.Rows
                If Not ar.Contains(drow("script").ToString & drow("company").ToString) Then
                    ar.Add(drow("script").ToString & drow("company").ToString)
                    count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                    If count > 1 Then
                        Dim brate As Double = 0
                        Dim srate As Double = 0
                        dr = dtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        dr("prqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                        dr("toqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >=#" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                        dr("units") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                        'dr("lots") = Val(dr("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")
                        srate = Math.Abs(Val(IIf(IsDBNull(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0 And company='" & drow("company") & "'")), 0, table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'"))))
                        brate = Val(IIf(IsDBNull(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0 And company='" & drow("company") & "'")), 0, table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'")))
                        If Val(dr("units")) = 0 Then
                            dr("traded") = Val((brate - srate))
                        Else
                            dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                        End If
                        dr("last") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("fut_mdate") = CDate(drow("mdate"))
                        dr("entrydate") = Today
                        dr("token1") = drow("token1")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("tokanno") = IIf(IsDBNull(scripttable.Compute("max(token)", "script='" & drow("script") & "'")), 0, scripttable.Compute("max(token)", "script='" & drow("script") & "'"))
                        dr("ftoken") = Val(scripttable.Compute("max(token)", "Symbol='" & GetSymbol(drow("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')").ToString)

                        If dr("ftoken") = 0 Then


                            Dim DtFMonthDate1 As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate1.Rows.Count > 0 Then
                                dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                            Else
                                Dim DtFMonthDate As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(drow("company")) & "' AND  InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate.Rows.Count > 0 Then
                                    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" And DtFMonthDate.Rows.Count = 1 Then
                                        dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count = 2 Then
                                        dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count = 3 Then
                                        dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                    End If
                                Else
                                    dr("fut_mdate") = Today
                                End If
                            End If

                           
                        End If
                            dr("status") = 1
                            dr("IsVolFix") = False

                            dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                            dr("IsCalc") = True

                            dr("preQty") = 0
                            dr("preDate") = Today
                            dr("preSpot") = 0
                            dr("preVol") = 0
                            dr("preDelVal") = 0
                            dr("preVegVal") = 0
                            dr("preTheVal") = 0

                            dr("curSpot") = 0
                            dr("curVol") = 0
                            dr("curDelVal") = 0
                            dr("curVegVal") = 0
                            dr("curTheVal") = 0

                            dr("preTotalMTM") = 0
                            dr("preGrossMTM") = 0
                            dr("curTotalMTM") = 0
                            dr("curGrossMTM") = 0


                            If CLng(dr("tokanno")) <> 0 Then
                                prExp = 0
                                toExp = 0
                                Call cal_position_expense(dr, prExp, toExp, "FO")
                                dr("prExp") = prExp
                                dr("toExp") = toExp
                                dr("totExp") = -(prExp + toExp)
                                dtable.Rows.Add(dr)
                            End If
                        Else
                            dr = dtable.NewRow()
                            dr("strikes") = Val(drow("strikerate"))
                            dr("prqty") = Val(IIf(IsDBNull(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'")), 0, table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'")))
                            dr("toqty") = Val(IIf(IsDBNull(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'")), 0, table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'")))
                            dr("units") = Val(drow("qty"))
                            'dr("lots") = Val(dr("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")
                            dr("traded") = Val(drow("rate"))
                            dr("last") = 0
                            dr("last1") = 0
                            dr("lv") = 0
                            dr("MktVol") = 0
                            dr("lv1") = 0
                            dr("cp") = drow("cp")
                            If Not IsDBNull(drow("cp")) Then
                                If drow("cp") = "C" Then
                                    dr("Cp") = "C"
                                ElseIf drow("cp") = "P" Then
                                    dr("Cp") = "P"
                                Else
                                    dr("Cp") = "F"
                                End If
                            Else
                                dr("Cp") = "F"
                            End If
                            dr("company") = CStr(drow("company"))
                            dr("script") = CStr(drow("script"))
                            dr("mdate") = CDate(drow("mdate"))
                            dr("fut_mdate") = CDate(drow("mdate"))
                            dr("entrydate") = Today
                            dr("token1") = drow("token1")
                            dr("isliq") = CBool(drow("isliq"))
                            dr("tokanno") = Val(scripttable.Compute("max(token)", "script='" & drow("script") & "'").ToString)
                            dr("ftoken") = Val(scripttable.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# and  InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')").ToString)
                            If dr("ftoken") = 0 Then

                                Dim DtFMonthDate1 As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate1.Rows.Count > 0 Then
                                    dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                    dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                                Else
                                    Dim DtFMonthDate As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(drow("company")) & "' AND  InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                    If DtFMonthDate.Rows.Count > 0 Then
                                        If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" And DtFMonthDate.Rows.Count = 1 Then
                                            dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                            dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                        ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count = 2 Then
                                            dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                            dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                        ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count = 3 Then
                                            dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                            dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                        End If
                                    Else
                                        dr("fut_mdate") = Today
                                    End If
                                End If


                            End If
                            dr("status") = 1
                            dr("IsVolFix") = False
                            dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                            dr("IsCalc") = True

                            dr("preQty") = 0
                            dr("preDate") = Today
                            dr("preSpot") = 0
                            dr("preVol") = 0
                            dr("preDelVal") = 0
                            dr("preVegVal") = 0
                            dr("preTheVal") = 0

                            dr("curSpot") = 0
                            dr("curVol") = 0
                            dr("curDelVal") = 0
                            dr("curVegVal") = 0
                            dr("curTheVal") = 0

                            dr("preTotalMTM") = 0
                            dr("preGrossMTM") = 0
                            dr("curTotalMTM") = 0
                            dr("curGrossMTM") = 0

                            If CLng(dr("tokanno")) <> 0 Then
                                prExp = 0
                                toExp = 0
                                Call cal_position_expense(dr, prExp, toExp, "FO")
                                dr("prExp") = prExp
                                dr("toExp") = toExp
                                dr("totExp") = -(prExp + toExp)
                                dtable.Rows.Add(dr)
                            End If
                        End If
                End If
            Next
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub
    ''' <summary>
    ''' fill_table
    ''' </summary>
    ''' <param name="table"></param>
    ''' <remarks>This method call to fill Maintable according to New FO Trade's datatable</remarks>

    Private Sub fill_table(ByVal table As DataTable)
        Dim tik As Long = System.Environment.TickCount
        Try
            'Comented because of Use in Getltp and it already called in bottom of function
            '//dtanalysisData = sel_analysis()


            Dim newPos As Boolean = False
            Dim dr As DataRow
            Dim prExp, toExp As Double
            'scripttable = cpfmaster
            Dim cpfmasterxx As DataTable = New DataView(cpfmaster, "option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token", "symbol", "option_type")
            Dim dtdata As DataTable = table.DefaultView.ToTable(True, "script", "company", "cp", "token1", "strikerate", "mdate")
            For Each drow As DataRow In table.DefaultView.ToTable(True, "script", "company", "cp", "token1", "strikerate", "mdate").Rows
                ' Dim DRdtdata() As DataRow = dtdata.Select("")
                ' For Each drow As DataRow In dtdata.Rows
                '  For Each drow As DataRow In DRdtdata
                newPos = True
                Dim objStrfo As Struct_FOContract
                objStrfo = New Struct_FOContract
                Dim dblltsize As Double = 0
                Dim token As Double = 0
                Dim asset_tokan As Double = 0
                If Not HT_FOContrct(drow("script").ToString().ToUpper()) Is Nothing Then
                    objStrfo = HT_FOContrct(drow("script").ToString().ToUpper())
                    dblltsize = objStrfo.lotsize
                    token = objStrfo.Token
                    asset_tokan = objStrfo.asset_tokan
                    'Else
                    '    dblltsize = 0
                    '    token = 0
                End If
                
                'Dim objStr As New Struct_FOContract

                'Dim token As Double
                'If Not HT_FOContrct(drow("script").ToString().ToUpper()) Is Nothing Then
                '    objStr = HT_FOContrct(drow("script").ToString().ToUpper())
                '    token = objStr.Token
                'Else
                '    token = 0
                'End If
                Dim dtcomp As DataTable = New DataView(table, "script='" & drow("script") & "'", "", DataViewRowState.CurrentRows).ToTable()
                For Each mrow As DataRow In maintable.Select("script = '" & drow("script").ToString.Trim & "' And company='" & drow("company").ToString.Trim & "'")
                    newPos = False
                    'Dim brate As Double = 0
                    'Dim srate As Double = 0
                    drow("script") = drow("script").ToString.Trim
                    drow("company") = drow("company").ToString.Trim

                    mrow("prqty") += Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                    mrow("toqty") += Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                    Dim currQty As Double = mrow("units")
                    prExp = 0
                    toExp = 0
                    mrow("units") = mrow("prqty") + mrow("toqty") 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString) 'Val(drow("qty"))
                    Dim VarTotalAmount As Double = mrow("traded") * IIf(currQty = 0, 1, currQty)

                    VarTotalAmount += dtcomp.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'")
                    If mrow("units") = 0 Then
                        mrow("traded") = VarTotalAmount
                    Else
                        mrow("traded") = VarTotalAmount / mrow("units")
                    End If

                    'Call cal_position_expense(mrow, prExp, toExp, "FO")
                    mrow("entrydate") = Today
                    mrow("deltaval") = 0
                    mrow("deltaval1") = 0

                    If mrow("cp") = "F" Then
                        mrow("deltaval") = mrow("units")
                        mrow("deltaval1") = mrow("units")
                    End If

                    mrow("prExp") = prExp
                    mrow("toExp") = toExp
                    mrow("totExp") = -(prExp + toExp)
                    '  mrow("lots") = Val(mrow("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")
                    mrow("Lots") = Val(mrow("units")) / dblltsize
                Next

                If newPos = True Then
                    dr = maintable.NewRow()
                    Dim brate As Double = 0
                    Dim srate As Double = 0
                    Dim count As Integer

                    drow("script") = drow("script").ToString.Trim
                    drow("company") = drow("company").ToString.Trim

                    dr("company") = drow("company")
                    dr("script") = drow("script")
                    dr("entrydate") = Format(Today, "dd-MMM-yyyy") 'CDate(Format(CDate(Today), "MM/dd/yyyy"))
                    dr("isliq") = False
                    dr("IsCalc") = True
                    'dr("tokanno") = drow("token1")


                    dr("lots") = Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")

                    'dr("prqty") = Val(GdtFOTrades.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < '" & Today & "'").ToString)
                    dr("prqty") = Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'").ToString)
                    dr("toqty") = Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)


                    dr("units") = Val(dtcomp.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                    '  count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                    count = CInt(dtcomp.Select("script='" & drow("script") & "' and company='" & drow("company") & "'").Length())
                    If count > 1 Then
                        srate = Math.Abs(Val(dtcomp.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString))
                        brate = Val(dtcomp.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
                        If Val(dr("units")) = 0 Then
                            dr("traded") = Val((brate - srate))
                        Else
                            dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                        End If
                    Else
                        dr("traded") = Val(dtcomp.Compute("sum(rate)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                    End If

                    '  dr("tokanno") = Val(cpfmaster.Compute("max(token)", "script='" & drow("script") & "'").ToString)
                    dr("tokanno") = token
                    dr("asset_tokan") = asset_tokan
                    dr("strikes") = Val(drow("strikerate"))
                    dr("cp") = drow("cp")
                    dr("fut_mdate") = CDate(drow("mdate")).Date
                    dr("ftoken") = Val(cpfmaster.Compute("max(token)", "Symbol='" & GetSymbol(drow("company")) & "' and expdate1=#" & Format(drow("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'").ToString)
                    If dr("ftoken") = 0 Then
                        Try


                            Dim DtFMonthDate1 As DataTable = New DataView(cpfmasterxx, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(drow("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate1.Rows.Count > 0 Then
                                dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                            Else
                                Dim DtFMonthDate As DataTable = New DataView(cpfmasterxx, "Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate.Rows.Count > 0 Then
                                    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                        dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count > 1 Then
                                        dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count > 2 Then
                                        dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                    End If
                                End If
                            End If
                        Catch ex As Exception

                        End Try
                    End If

                    dr("mdate") = CDate(drow("mdate")).Date
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("month") = Format(CDate(drow("mdate")), "MMM yy")
                    ' dr("token1") = Val(GdtFOTrades.Compute("max(token1)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                    dr("token1") = token
                    prExp = 0
                    toExp = 0
                    'Call cal_position_expense(dr, prExp, toExp, "FO")
                    dr("IsCurrency") = False
                    dr("status") = 1
                    dr("last") = 0
                    dr("flast") = 0
                    dr("last1") = 0
                    dr("lv") = 0
                    dr("MktVol") = 0
                    dr("lv1") = 0
                    'dr("delta") = 1
                    'dr("deltaval") = Val(dr("units"))
                    dr("delta") = 0
                    dr("deltaval") = 0
                    dr("deltaval1") = 0
                    If dr("cp") = "F" Then
                        dr("delta") = 1
                        dr("deltaval") = dr("units")
                        dr("deltaval1") = dr("units")
                    End If
                    dr("theta") = 0
                    dr("thetaval") = 0
                    dr("vega") = 0
                    dr("vgval") = 0
                    dr("gamma") = 0
                    dr("gmval") = 0
                    dr("toatp") = 0
                    dr("pratp") = 0
                    'dr("deltaval1") = Val(dr("units"))
                    dr("thetaval1") = 0
                    dr("vgval1") = 0
                    dr("gmval1") = 0

                    dr("volga") = 0
                    dr("vanna") = 0
                    dr("volgaval") = 0
                    dr("vannaval") = 0
                    dr("volgaval1") = 0
                    dr("vannaval1") = 0
                    If dr("mdate") = Today.Date Then
                        dr("deltaval1") = 0
                        dr("thetaval1") = 0
                        dr("vgval1") = 0
                        dr("gmval1") = 0
                        dr("volgaval1") = 0
                        dr("vannaval1") = 0
                    End If
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("prExp") = prExp
                    dr("toExp") = toExp
                    dr("totExp") = -(prExp + toExp)
                    dr("IsVolFix") = False
                    dr("DeltaN") = 0
                    dr("GammaN") = 0
                    dr("VegaN") = 0
                    dr("ThetaN") = 0
                    dr("VolgaN") = 0
                    dr("VannaN") = 0
                    If CLng(dr("tokanno")) <> 0 Then
                        maintable.Rows.Add(dr)
                    End If
                    'maintable.Rows.Add(dr)
                End If
            Next
            If maintable.Rows.Count > 0 Then
                If maintable.Compute("count(tokanno)", "last=0") > 0 Then
                    'Rem While Set FixVol  in Next Refresh  FixVol Remove From Data Because Of in GetLtp Function ReSet Vol From GreekDb(Analysis Table) 
                    dtanalysisData = sel_analysis()
                    get_ltp(maintable)
                End If
            End If
            'delete_analysis()
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
        Write_TradeLog_viral("FillTable", tik, System.Environment.TickCount)
    End Sub
    ''' <summary>
    ''' fill_table
    ''' </summary>
    ''' <param name="table"></param>
    ''' <remarks>This method call to fill Maintable according to New FO Trade's datatable</remarks>
    
    'Private Sub fill_table(ByVal table As DataTable)
    '    Try
    '        dtanalysisData = sel_analysis()
    '        Dim newPos As Boolean = False
    '        Dim dr As DataRow
    '        Dim prExp, toExp As Double
    '        'scripttable = cpfmaster
    '        For Each drow As DataRow In table.DefaultView.ToTable(True, "script", "company", "cp", "token1", "strikerate", "mdate").Rows
    '            newPos = True

    '            For Each mrow As DataRow In maintable.Select("script = '" & drow("script").ToString.Trim & "' And company='" & drow("company").ToString.Trim & "'")
    '                newPos = False
    '                'Dim brate As Double = 0
    '                'Dim srate As Double = 0
    '                drow("script") = drow("script").ToString.Trim
    '                drow("company") = drow("company").ToString.Trim

    '                mrow("prqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
    '                mrow("toqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
    '                Dim currQty As Double = mrow("units")
    '                prExp = 0
    '                toExp = 0
    '                mrow("units") = mrow("prqty") + mrow("toqty") 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString) 'Val(drow("qty"))
    '                Dim VarTotalAmount As Double = mrow("traded") * IIf(currQty = 0, 1, currQty)

    '                VarTotalAmount += table.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'")
    '                If mrow("units") = 0 Then
    '                    mrow("traded") = VarTotalAmount
    '                Else
    '                    mrow("traded") = VarTotalAmount / mrow("units")
    '                End If

    '                'Call cal_position_expense(mrow, prExp, toExp, "FO")
    '                mrow("entrydate") = Today
    '                mrow("deltaval") = 0
    '                mrow("deltaval1") = 0

    '                If mrow("cp") = "F" Then
    '                    mrow("deltaval") = mrow("units")
    '                    mrow("deltaval1") = mrow("units")
    '                End If

    '                mrow("prExp") = prExp
    '                mrow("toExp") = toExp
    '                mrow("totExp") = -(prExp + toExp)
    '                mrow("lots") = Val(mrow("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")
    '            Next

    '            If newPos = True Then
    '                dr = maintable.NewRow()
    '                Dim brate As Double = 0
    '                Dim srate As Double = 0
    '                Dim count As Integer

    '                drow("script") = drow("script").ToString.Trim
    '                drow("company") = drow("company").ToString.Trim

    '                dr("company") = drow("company")
    '                dr("script") = drow("script")
    '                dr("entrydate") = Format(Today, "dd-MMM-yyyy") 'CDate(Format(CDate(Today), "MM/dd/yyyy"))
    '                dr("isliq") = False
    '                dr("IsCalc") = True
    '                'dr("tokanno") = drow("token1")


    '                dr("lots") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString) / cpfmaster.Compute("MAX(lotsize)", "script = '" & drow("script") & "'")

    '                'dr("prqty") = Val(GdtFOTrades.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < '" & Today & "'").ToString)
    '                dr("prqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'").ToString)
    '                dr("toqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)


    '                dr("units") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
    '                count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
    '                If count > 1 Then
    '                    srate = Math.Abs(Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString))
    '                    brate = Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
    '                    If Val(dr("units")) = 0 Then
    '                        dr("traded") = Val((brate - srate))
    '                    Else
    '                        dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
    '                    End If
    '                Else
    '                    dr("traded") = Val(table.Compute("sum(rate)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
    '                End If

    '                dr("tokanno") = Val(cpfmaster.Compute("max(token)", "script='" & drow("script") & "'").ToString)
    '                dr("strikes") = Val(drow("strikerate"))
    '                dr("cp") = drow("cp")
    '                dr("fut_mdate") = CDate(drow("mdate")).Date
    '                dr("ftoken") = Val(cpfmaster.Compute("max(token)", "Symbol='" & GetSymbol(drow("company")) & "' and expdate1=#" & Format(drow("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'").ToString)
    '                If dr("ftoken") = 0 Then
    '                    Dim DtFMonthDate As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
    '                    If DtFMonthDate.Rows.Count > 0 Then
    '                        If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
    '                            dr("ftoken") = DtFMonthDate.Rows(0)("token")
    '                            dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
    '                        ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count > 1 Then
    '                            dr("ftoken") = DtFMonthDate.Rows(1)("token")
    '                            dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
    '                        ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count > 2 Then
    '                            dr("ftoken") = DtFMonthDate.Rows(2)("token")
    '                            dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
    '                        End If
    '                    End If
    '                End If

    '                dr("mdate") = CDate(drow("mdate")).Date
    '                dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
    '                dr("month") = Format(CDate(drow("mdate")), "MMM yy")
    '                dr("token1") = Val(GdtFOTrades.Compute("max(token1)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
    '                prExp = 0
    '                toExp = 0
    '                'Call cal_position_expense(dr, prExp, toExp, "FO")
    '                dr("IsCurrency") = False
    '                dr("status") = 1
    '                dr("last") = 0
    '                dr("flast") = 0
    '                dr("last1") = 0
    '                dr("lv") = 0
    '                dr("MktVol") = 0
    '                dr("lv1") = 0
    '                'dr("delta") = 1
    '                'dr("deltaval") = Val(dr("units"))
    '                dr("delta") = 0
    '                dr("deltaval") = 0
    '                dr("deltaval1") = 0
    '                If dr("cp") = "F" Then
    '                    dr("delta") = 1
    '                    dr("deltaval") = dr("units")
    '                    dr("deltaval1") = dr("units")
    '                End If
    '                dr("theta") = 0
    '                dr("thetaval") = 0
    '                dr("vega") = 0
    '                dr("vgval") = 0
    '                dr("gamma") = 0
    '                dr("gmval") = 0
    '                dr("toatp") = 0
    '                dr("pratp") = 0
    '                'dr("deltaval1") = Val(dr("units"))
    '                dr("thetaval1") = 0
    '                dr("vgval1") = 0
    '                dr("gmval1") = 0

    '                dr("volga") = 0
    '                dr("vanna") = 0
    '                dr("volgaval") = 0
    '                dr("vannaval") = 0
    '                dr("volgaval1") = 0
    '                dr("vannaval1") = 0
    '                If dr("mdate") = Today.Date Then
    '                    dr("deltaval1") = 0
    '                    dr("thetaval1") = 0
    '                    dr("vgval1") = 0
    '                    dr("gmval1") = 0
    '                    dr("volgaval1") = 0
    '                    dr("vannaval1") = 0
    '                End If
    '                dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
    '                dr("prExp") = prExp
    '                dr("toExp") = toExp
    '                dr("totExp") = -(prExp + toExp)
    '                dr("IsVolFix") = False
    '                dr("DeltaN") = 0
    '                dr("GammaN") = 0
    '                dr("VegaN") = 0
    '                dr("ThetaN") = 0
    '                dr("VolgaN") = 0
    '                dr("VannaN") = 0
    '                If CLng(dr("tokanno")) <> 0 Then
    '                    maintable.Rows.Add(dr)
    '                End If
    '                'maintable.Rows.Add(dr)
    '            End If
    '        Next
    '        If maintable.Rows.Count > 0 Then
    '            If maintable.Compute("count(tokanno)", "last=0") > 0 Then
    '                'Rem While Set FixVol  in Next Refresh  FixVol Remove From Data Because Of in GetLtp Function ReSet Vol From GreekDb(Analysis Table) 
    '                dtanalysisData = sel_analysis()
    '                get_ltp(maintable)
    '            End If
    '        End If
    '        'delete_analysis()
    '    Catch ex As Exception
    '        MsgBox(ex.ToString)
    '    End Try
    'End Sub

    ''' <summary>
    ''' fill_equity
    ''' </summary>
    ''' <param name="table"></param>
    ''' <remarks>This method call to fill Maintable according to New EQ Trade's datatable</remarks>
    Private Sub fill_equity(ByVal table As DataTable)
        Try
            'eqsecurity = eqmaster
            Dim dr As DataRow
            Dim ar As New ArrayList
            Dim prExp, toExp As Double
            Dim newPos As Boolean = False
            For Each drow As DataRow In table.DefaultView.ToTable(True, "script", "company", "eq").Rows
                newPos = True
                Dim dvtable As DataTable = New DataView(table, "script = '" & drow("script") & "'", "", DataViewRowState.CurrentRows).ToTable
                For Each mrow As DataRow In maintable.Select("script = '" & drow("script") & "' ")
                    newPos = False
                    'Dim brate As Double = 0
                    'Dim srate As Double = 0
                    mrow("prqty") += Val(dvtable.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# ").ToString)
                    mrow("toqty") += Val(dvtable.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "#").ToString)

                    Dim currQty As Double = mrow("units")
                    prExp = 0
                    toExp = 0
                    mrow("units") = mrow("prqty") + mrow("toqty") 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString)

                    Dim VarTotalAmount As Double = mrow("traded") * IIf(currQty = 0, 1, currQty)
                    VarTotalAmount += dvtable.Compute("sum(tot)", "script='" & drow("script") & "' ")
                    If mrow("units") = 0 Then
                        mrow("traded") = VarTotalAmount
                    Else
                        mrow("traded") = VarTotalAmount / mrow("units")
                    End If

                    mrow("entrydate") = Today
                    mrow("deltaval") = mrow("units")
                    mrow("deltaval1") = mrow("units")
                    mrow("prExp") = prExp
                    mrow("toExp") = toExp
                    mrow("totExp") = -(prExp + toExp)
                Next
                If newPos = True Then
                    Dim brate As Double = 0
                    Dim count As Integer = 0
                    Dim srate As Double = 0
                    dr = maintable.NewRow()

                    dr("company") = drow("company")
                    dr("script") = drow("script")
                    dr("entrydate") = Today
                    dr("isliq") = False
                    'dr("tokanno") = drow("tokanno")




                 
                    For Each row As DataRow In eqmaster.Select("script='" & drow("script") & "'")
                        dr("tokanno") = CStr(row("token"))
                    Next

                    dr("prqty") = Val(dvtable.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# ").ToString)
                    dr("toqty") = Val(dvtable.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# ").ToString)

                    ' Math.Round(Val(drow("traded")), 5)

                    dr("units") = Val(dvtable.Compute("sum(qty)", "script='" & drow("script") & "' ").ToString)

                    count = CInt(dvtable.Compute("count(script)", "script='" & drow("script") & "' "))
                    If count > 1 Then
                        srate = Math.Abs(Val(dvtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  ").ToString))
                        brate = Math.Abs(Val(dvtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  ").ToString))

                        If Val(dr("units")) = 0 Then
                            dr("traded") = Val((brate - srate))
                        Else
                            dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                        End If
                    Else
                        dr("traded") = Val(dvtable.Compute("sum(rate)", "script='" & drow("script") & "' ").ToString)
                    End If

                    dr("strikes") = 0
                    dr("cp") = "E" 'drow("eq")
                    dr("mdate") = Today
                    dr("month") = (Format(CDate(dr("mdate")), "MMM yy"))
                    'dr("fut_mdate") = CDate(Format(CDate(Today), "MM/dd/yyyy"))
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("asset_tokan") = 0
                    dr("token1") = 0
                    Dim Drcpf() As DataRow = cpfmaster.Select("Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX') AND expdate1 >= #" & Format(Today, "dd-MMM-yyyy") & "#", "expdate1")
                    If Drcpf.Length > 0 Then
                        dr("ftoken") = Drcpf(0)("token")
                        dr("fut_mdate") = Drcpf(0)("expDate1")
                    Else
                        dr("ftoken") = 0
                        dr("fut_mdate") = Today
                    End If
                    prExp = 0
                    toExp = 0
                    'Call cal_position_expense(dr, prExp, toExp, "EQ")
                    dr("IsCurrency") = False
                    dr("Lots") = 0
                    dr("status") = 1
                    dr("last") = 0
                    dr("flast") = 0
                    dr("last1") = 0
                    dr("lv") = 0
                    dr("MktVol") = 0
                    dr("lv1") = 0
                    'dr("delta") = 1
                    'dr("deltaval") = Val(dr("units"))
                    ''dr("delta") = 0
                    ''dr("deltaval") = 0
                    ''dr("deltaval1") = 0

                    If dr("cp") = "E" Then
                        dr("delta") = 1
                        dr("deltaval") = dr("units")
                        dr("deltaval1") = dr("units")
                    End If

                    dr("IsCalc") = True
                    dr("theta") = 0
                    dr("thetaval") = 0
                    dr("vega") = 0
                    dr("vgval") = 0
                    dr("gamma") = 0
                    dr("gmval") = 0
                    dr("toatp") = 0
                    dr("pratp") = 0
                    'dr("deltaval1") = Val(dr("units"))
                    dr("thetaval1") = 0
                    dr("vgval1") = 0
                    dr("gmval1") = 0
                    dr("volga") = 0

                    dr("vanna") = 0
                    dr("volgaval") = 0
                    dr("vannaval") = 0
                    dr("volgaval1") = 0
                    dr("vannaval1") = 0
                    dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                    dr("prExp") = prExp
                    dr("toExp") = toExp
                    dr("totExp") = -(prExp + toExp)
                    maintable.Rows.Add(dr)
                End If
            Next
            If maintable.Rows.Count > 0 Then
                If maintable.Compute("count(tokanno)", "last=0") > 0 Then
                    dtanalysisData = sel_analysis()
                    get_ltp(maintable)
                End If
            End If
            'delete_analysis()
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub
    'Private Sub fill_equity(ByVal table As DataTable)
    '    Try
    '        'eqsecurity = eqmaster
    '        Dim dr As DataRow
    '        Dim ar As New ArrayList
    '        Dim prExp, toExp As Double
    '        Dim newPos As Boolean = False
    '        For Each drow As DataRow In table.DefaultView.ToTable(True, "script", "company", "eq").Rows
    '            newPos = True
    '            For Each mrow As DataRow In maintable.Select("script = '" & drow("script") & "' And company='" & drow("company") & "'")
    '                newPos = False
    '                'Dim brate As Double = 0
    '                'Dim srate As Double = 0
    '                mrow("prqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
    '                mrow("toqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)

    '                Dim currQty As Double = mrow("units")
    '                prExp = 0
    '                toExp = 0
    '                mrow("units") = mrow("prqty") + mrow("toqty") 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString)

    '                Dim VarTotalAmount As Double = mrow("traded") * IIf(currQty = 0, 1, currQty)
    '                VarTotalAmount += table.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'")
    '                If mrow("units") = 0 Then
    '                    mrow("traded") = VarTotalAmount
    '                Else
    '                    mrow("traded") = VarTotalAmount / mrow("units")
    '                End If

    '                mrow("entrydate") = Today
    '                mrow("deltaval") = mrow("units")
    '                mrow("deltaval1") = mrow("units")
    '                mrow("prExp") = prExp
    '                mrow("toExp") = toExp
    '                mrow("totExp") = -(prExp + toExp)
    '            Next
    '            If newPos = True Then
    '                Dim brate As Double = 0
    '                Dim count As Integer = 0
    '                Dim srate As Double = 0
    '                dr = maintable.NewRow()

    '                dr("company") = drow("company")
    '                dr("script") = drow("script")
    '                dr("entrydate") = Today
    '                dr("isliq") = False
    '                'dr("tokanno") = drow("tokanno")

    '                For Each row As DataRow In eqmaster.Select("script='" & drow("script") & "'")
    '                    dr("tokanno") = CStr(row("token"))
    '                Next

    '                dr("prqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
    '                dr("toqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)

    '                ' Math.Round(Val(drow("traded")), 5)

    '                dr("units") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)

    '                count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
    '                If count > 1 Then
    '                    srate = Math.Abs(Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString))
    '                    brate = Math.Abs(Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString))

    '                    If Val(dr("units")) = 0 Then
    '                        dr("traded") = Val((brate - srate))
    '                    Else
    '                        dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
    '                    End If
    '                Else
    '                    dr("traded") = Val(table.Compute("sum(rate)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
    '                End If

    '                dr("strikes") = 0
    '                dr("cp") = "E" 'drow("eq")
    '                dr("mdate") = Today
    '                dr("month") = (Format(CDate(dr("mdate")), "MMM yy"))
    '                'dr("fut_mdate") = CDate(Format(CDate(Today), "MM/dd/yyyy"))
    '                dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
    '                dr("asset_tokan") = 0
    '                dr("token1") = 0
    '                Dim Drcpf() As DataRow = cpfmaster.Select("Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX') AND expdate1 >= #" & Format(Today, "dd-MMM-yyyy") & "#", "expdate1")
    '                If Drcpf.Length > 0 Then
    '                    dr("ftoken") = Drcpf(0)("token")
    '                    dr("fut_mdate") = Drcpf(0)("expDate1")
    '                Else
    '                    dr("ftoken") = 0
    '                    dr("fut_mdate") = Today
    '                End If
    '                prExp = 0
    '                toExp = 0
    '                'Call cal_position_expense(dr, prExp, toExp, "EQ")
    '                dr("IsCurrency") = False
    '                dr("Lots") = 0
    '                dr("status") = 1
    '                dr("last") = 0
    '                dr("flast") = 0
    '                dr("last1") = 0
    '                dr("lv") = 0
    '                dr("MktVol") = 0
    '                dr("lv1") = 0
    '                'dr("delta") = 1
    '                'dr("deltaval") = Val(dr("units"))
    '                ''dr("delta") = 0
    '                ''dr("deltaval") = 0
    '                ''dr("deltaval1") = 0

    '                If dr("cp") = "E" Then
    '                    dr("delta") = 1
    '                    dr("deltaval") = dr("units")
    '                    dr("deltaval1") = dr("units")
    '                End If
    '                dr("theta") = 0
    '                dr("thetaval") = 0
    '                dr("vega") = 0
    '                dr("vgval") = 0
    '                dr("gamma") = 0
    '                dr("gmval") = 0
    '                dr("toatp") = 0
    '                dr("pratp") = 0
    '                'dr("deltaval1") = Val(dr("units"))
    '                dr("thetaval1") = 0
    '                dr("vgval1") = 0
    '                dr("gmval1") = 0
    '                dr("volga") = 0

    '                dr("vanna") = 0
    '                dr("volgaval") = 0
    '                dr("vannaval") = 0
    '                dr("volgaval1") = 0
    '                dr("vannaval1") = 0
    '                dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
    '                dr("prExp") = prExp
    '                dr("toExp") = toExp
    '                dr("totExp") = -(prExp + toExp)
    '                maintable.Rows.Add(dr)
    '            End If
    '        Next
    '        If maintable.Rows.Count > 0 Then
    '            If maintable.Compute("count(tokanno)", "last=0") > 0 Then
    '                dtanalysisData = sel_analysis()
    '                get_ltp(maintable)
    '            End If
    '        End If
    '        'delete_analysis()
    '    Catch ex As Exception
    '        MsgBox(ex.ToString)
    '    End Try
    'End Sub

    ''' <summary>
    ''' fill_equity
    ''' Used in Process_data While Calculate data after perform DeleteData
    ''' </summary>
    ''' <remarks>This method call to fill Maintable according to EQ Trade's datatable</remarks>
    Private Sub fill_equity()
        Try
            eqsecurity = eqmaster
            Dim temtable As New DataTable
            GdtEQTrades = objTrad.select_equity
            temtable = GdtEQTrades 'objTrad.select_equity
            Dim count As Integer
            Dim dr As DataRow
            Dim ar As New ArrayList
            For Each drow As DataRow In temtable.Rows
                count = CInt(temtable.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                If count > 1 Then
                    If Not ar.Contains(drow("script").ToString & drow("company").ToString) Then
                        Dim brate As Double = 0
                        Dim srate As Double = 0
                        ar.Add(drow("script").ToString & drow("company").ToString)
                        dr = eqtable.NewRow()
                        dr("script") = drow("script")
                        dr("company") = drow("company")
                        dr("eq") = CStr(drow("eq"))
                        dr("prqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                        dr("toqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                        dr("qty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                        For Each row As DataRow In temtable.Select("script='" & drow("script") & "' And company='" & drow("company") & "'")
                            If Val(row("qty")) < 0 Then
                                srate = srate + (-Val(row("tot")))
                            Else
                                brate = brate + Val(row("tot"))
                            End If
                        Next
                        If Val(dr("qty")) = 0 Then
                            dr("rate") = Math.Round(Val((brate - srate)), 2)
                        Else
                            dr("rate") = Math.Round(Val((brate - srate) / Val(dr("qty"))), 2)
                        End If

                        'dr("uid") = CInt(drow("uid"))
                        dr("entrydate") = Today
                        dr("entryno") = Val(drow("entryno"))
                        dr("toatp") = 0
                        dr("pratp") = 0

                        For Each row As DataRow In eqsecurity.Select("script='" & drow("script") & "'")
                            dr("tokanno") = CStr(row("token"))
                            eqtable.Rows.Add(dr)
                        Next
                    End If
                Else
                    dr = eqtable.NewRow()
                    dr("script") = drow("script")
                    dr("company") = drow("company")
                    dr("eq") = CStr(drow("eq"))
                    dr("prqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                    dr("toqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)

                    dr("qty") = Val(drow("qty"))
                    dr("rate") = Val(drow("rate"))
                    'dr("uid") = CInt(drow("uid"))
                    dr("entrydate") = Today
                    dr("entryno") = Val(drow("entryno"))
                    dr("toatp") = 0
                    dr("pratp") = 0
                    For Each row As DataRow In eqsecurity.Select("script='" & drow("script") & "'")
                        dr("tokanno") = CStr(row("token"))
                        eqtable.Rows.Add(dr)
                    Next
                End If
            Next

        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try

    End Sub

    ''' <summary>
    ''' Used in Process_data While Calculate data after perform DeleteData
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub fill_Currency()
        Try
            Dim dr As DataRow
            Dim count As Integer
            Dim ar As New ArrayList
            Dim table As New DataTable
            'table = New DataTable
            GdtCurrencyTrades = objTrad.select_Currency_Trading
            table = GdtCurrencyTrades 'objTrad.Trading
            CurrScript = Currencymaster

            Dim prExp, toExp As Double
            For Each drow As DataRow In table.Rows
                If Not ar.Contains(drow("script").ToString & drow("company").ToString) Then
                    ar.Add(drow("script").ToString & drow("company").ToString)
                    count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                    If count > 1 Then
                        Dim brate As Double = 0
                        Dim srate As Double = 0
                        dr = dtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        dr("prqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                        dr("toqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'").ToString)
                        dr("units") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))

                        srate = Math.Abs(Val(IIf(IsDBNull(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'")), 0, table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'"))))
                        brate = Val(IIf(IsDBNull(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'")), 0, table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'")))
                        If Val(dr("units")) = 0 Then
                            dr("traded") = Val((brate - srate))
                        Else
                            dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                        End If
                        dr("last") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("fut_mdate") = CDate(drow("mdate"))
                        dr("entrydate") = Today
                        dr("token1") = drow("token1")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("tokanno") = IIf(IsDBNull(CurrScript.Compute("max(token)", "script='" & drow("script") & "'")), 0, CurrScript.Compute("max(token)", "script='" & drow("script") & "'"))
                        dr("ftoken") = IIf(IsDBNull(CurrScript.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'")), 0, CurrScript.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'"))
                        If dr("ftoken") = 0 Then
                            Dim DtFMonthDate1 As DataTable = New DataView(CurrScript, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate1.Rows.Count > 0 Then
                                dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                            Else
                                Dim DtFMonthDate As DataTable = New DataView(CurrScript, "Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate.Rows.Count > 0 Then
                                    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" And DtFMonthDate.Rows.Count = 1 Then
                                        dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count = 2 Then
                                        dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count = 3 Then
                                        dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                    End If
                                End If
                            End If
                            
                        End If
                            dr("status") = 1

                            dr("IsVolFix") = False

                            dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0


                            dr("IsCalc") = True

                            dr("preQty") = 0
                            dr("preDate") = Today
                            dr("preSpot") = 0
                            dr("preVol") = 0
                            dr("preDelVal") = 0
                            dr("preVegVal") = 0
                            dr("preTheVal") = 0

                            dr("curSpot") = 0
                            dr("curVol") = 0
                            dr("curDelVal") = 0
                            dr("curVegVal") = 0
                            dr("curTheVal") = 0

                            dr("preTotalMTM") = 0
                            dr("preGrossMTM") = 0
                            dr("curTotalMTM") = 0
                            dr("curGrossMTM") = 0

                            If CLng(dr("tokanno")) <> 0 Then
                                prExp = 0
                                toExp = 0
                                Call cal_position_expense(dr, prExp, toExp, "CURR")
                                dr("prExp") = prExp
                                dr("toExp") = toExp
                                dr("totExp") = -(prExp + toExp)
                                dtable.Rows.Add(dr)
                            End If
                        Else
                            dr = dtable.NewRow()
                            dr("strikes") = Val(drow("strikerate"))
                            dr("prqty") = Val(IIf(IsDBNull(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "#")), 0, table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'")))
                            dr("toqty") = Val(IIf(IsDBNull(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "# ")), 0, table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'")))
                            dr("units") = Val(drow("qty"))
                            dr("traded") = Val(drow("rate"))
                            dr("last") = 0
                            dr("last1") = 0
                            dr("lv") = 0
                            dr("MktVol") = 0
                            dr("lv1") = 0
                            dr("cp") = drow("cp")
                            If Not IsDBNull(drow("cp")) Then
                                If drow("cp") = "C" Then
                                    dr("Cp") = "C"
                                ElseIf drow("cp") = "P" Then
                                    dr("Cp") = "P"
                                Else
                                    dr("Cp") = "F"
                                End If
                            Else
                                dr("Cp") = "F"
                            End If
                            dr("company") = CStr(drow("company"))
                            dr("script") = CStr(drow("script"))
                            dr("mdate") = CDate(drow("mdate"))
                            dr("fut_mdate") = CDate(drow("mdate"))
                            dr("entrydate") = Today
                            dr("token1") = drow("token1")
                            dr("isliq") = CBool(drow("isliq"))
                            dr("tokanno") = Val(CurrScript.Compute("max(token)", "script='" & drow("script") & "'").ToString)
                            dr("ftoken") = Val(CurrScript.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'").ToString)
                        If dr("ftoken") = 0 Then
                            Dim DtFMonthDate1 As DataTable = New DataView(CurrScript, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate1.Rows.Count > 0 Then
                                dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                            Else
                                Dim DtFMonthDate As DataTable = New DataView(CurrScript, "Symbol='" & GetSymbol(drow("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate.Rows.Count > 0 Then
                                    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" And DtFMonthDate.Rows.Count = 1 Then
                                        dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count = 2 Then
                                        dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count = 3 Then
                                        dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                    End If
                                End If
                            End If
                            
                        End If
                            dr("status") = 1
                            dr("IsVolFix") = False

                            dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0


                            dr("IsCalc") = True

                            dr("preQty") = 0
                            dr("preDate") = Today
                            dr("preSpot") = 0
                            dr("preVol") = 0
                            dr("preDelVal") = 0
                            dr("preVegVal") = 0
                            dr("preTheVal") = 0

                            dr("curSpot") = 0
                            dr("curVol") = 0
                            dr("curDelVal") = 0
                            dr("curVegVal") = 0
                            dr("curTheVal") = 0

                            dr("preTotalMTM") = 0
                            dr("preGrossMTM") = 0
                            dr("curTotalMTM") = 0
                            dr("curGrossMTM") = 0

                            If CLng(dr("tokanno")) <> 0 Then
                                prExp = 0
                                toExp = 0
                                Call cal_position_expense(dr, prExp, toExp, "CURR")
                                dr("prExp") = prExp
                                dr("toExp") = toExp
                                dr("totExp") = -(prExp + toExp)
                                dtable.Rows.Add(dr)
                            End If
                        End If
                End If
            Next
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub

    REM For Currency directly maintable Update 19-11-2010
    Private Sub fill_Currency(ByVal table As DataTable)
        Try
            Dim dr As DataRow
            Dim ar As New ArrayList
            Dim newPos As Boolean = False
            Dim prExp, toExp As Double
            'CurrScript = Currencymaster
            For Each drow As DataRow In table.DefaultView.ToTable(True, "script", "company", "cp", "token1", "strikerate", "mdate").Rows
                newPos = True
                For Each mrow As DataRow In maintable.Select("script = '" & drow("script") & "' And company='" & drow("company") & "'")
                    newPos = False
                    Dim brate As Double = 0
                    Dim srate As Double = 0
                    mrow("prqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                    mrow("toqty") += Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'").ToString)
                    Dim currQty As Double = mrow("units")
                    prExp = 0
                    toExp = 0
                    mrow("units") = mrow("prqty") + mrow("toqty") 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString) 'Val(drow("qty"))
                    srate = Math.Abs(Val(GdtCurrencyTrades.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString))
                    brate = Math.Abs(Val(GdtCurrencyTrades.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString))
                    If Val(mrow("units")) = 0 Then
                        mrow("traded") = Val((brate - srate))
                    Else
                        mrow("traded") = Val((brate - srate) / mrow("units")) 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'").ToString)) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                    End If
                    'Call cal_position_expense(mrow, prExp, toExp, "CURR")
                    mrow("entrydate") = Today
                    mrow("deltaval") = 0
                    mrow("deltaval1") = 0
                    If mrow("CP") = "F" Then
                        mrow("deltaval") = mrow("units")
                        mrow("deltaval1") = mrow("units")
                    End If
                    ''mrow("deltaval") = mrow("units")
                    ''mrow("deltaval1") = mrow("units")
                    mrow("prExp") = prExp
                    mrow("toExp") = toExp
                    mrow("totExp") = -(prExp + toExp)
                    mrow("lots") = Val(Val(mrow("units")) / Currencymaster.Compute("MAX(multiplier)", "script = '" & drow("script") & "'"))
                Next
                If newPos = True Then
                    Dim count As Integer = 0
                    Dim brate As Double = 0
                    Dim srate As Double = 0

                    dr = maintable.NewRow()
                    dr("company") = drow("company")
                    dr("script") = drow("script")

                    dr("entrydate") = Today

                    dr("isliq") = False


                    dr("prqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate < #" & Format(Today, "dd-MMM-yyyy") & "# And company='" & drow("company") & "'").ToString)
                    dr("toqty") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and EntryDate >= #" & Format(Today, "dd-MMM-yyyy") & "#  And company='" & drow("company") & "'").ToString)

                    dr("lots") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString) / Currencymaster.Compute("MAX(multiplier)", "script = '" & drow("script") & "'")

                    dr("units") = Val(table.Compute("sum(qty)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                    count = CInt(table.Compute("count(script)", "script='" & drow("script") & "' And company='" & drow("company") & "'"))
                    If count > 1 Then
                        srate = Math.Abs(Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString))
                        brate = Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
                        If Val(dr("units")) = 0 Then
                            dr("traded") = Val((brate - srate))
                        Else
                            dr("traded") = Val((brate - srate) / Val(dr("units"))) ' Math.Round(val((brate - srate) / val(dr("units"))), 2)
                        End If
                    Else
                        dr("traded") = Val(table.Compute("sum(rate)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                    End If

                    dr("strikes") = Val(drow("strikerate"))
                    dr("cp") = drow("cp")
                    dr("mdate") = drow("mdate")
                    dr("month") = Format(CDate(drow("mdate")), "MMM yy")

                    dr("tokanno") = IIf(IsDBNull(Currencymaster.Compute("max(token)", "script='" & drow("script") & "'")), 0, Currencymaster.Compute("max(token)", "script='" & drow("script") & "'"))
                    dr("ftoken") = Val(Currencymaster.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# AND option_type='XX'").ToString)
                    dr("fut_mdate") = drow("mdate")
                    If dr("ftoken") = 0 Then
                        Dim DtFMonthDate1 As DataTable = New DataView(Currencymaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                        If DtFMonthDate1.Rows.Count > 0 Then
                            dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                            dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                        Else
                            Dim DtFMonthDate As DataTable = New DataView(Currencymaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate.Rows.Count > 0 Then
                                If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                    dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                    dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" Then
                                    dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                    dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" Then
                                    dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                    dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                End If
                            End If
                        End If



                        
                    End If

                        dr("token1") = IIf(IsDBNull(GdtCurrencyTrades.Compute("max(token)", "script='" & drow("script") & "' And company='" & drow("company") & "'")), 0, Currencymaster.Compute("max(token)", "script='" & drow("script") & "'"))

                        prExp = 0
                        toExp = 0
                        'Call cal_position_expense(dr, prExp, toExp, "CURR")
                        dr("IsCurrency") = True
                        dr("status") = 1
                        dr("last") = 0
                        dr("flast") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        'dr("delta") = 1
                        'dr("deltaval") = Val(dr("units"))
                        dr("delta") = 0
                        dr("deltaval") = 0
                        dr("deltaval1") = 0
                        If dr("cp") = "F" Then
                            dr("delta") = 1
                            dr("deltaval") = dr("units")
                            dr("deltaval1") = dr("units")
                        End If

                        dr("theta") = 0
                        dr("thetaval") = 0
                        dr("vega") = 0
                        dr("vgval") = 0
                        dr("gamma") = 0
                        dr("gmval") = 0
                        dr("toatp") = 0
                        dr("pratp") = 0
                        'dr("deltaval1") = Val(dr("units"))
                        dr("thetaval1") = 0
                        dr("vgval1") = 0
                        dr("gmval1") = 0
                        dr("volga") = 0
                        dr("vanna") = 0
                        dr("volgaval") = 0
                        dr("vannaval") = 0
                        dr("volgaval1") = 0
                        dr("vannaval1") = 0
                        If dr("mdate") = Today.Date Then
                            dr("deltaval1") = 0
                            dr("thetaval1") = 0
                            dr("vgval1") = 0
                            dr("gmval1") = 0
                            dr("volgaval1") = 0
                            dr("vannaval1") = 0
                        End If
                        dr("mdate_months") = (CDate(dr("mdate")).Year * 12) + (CDate(dr("mdate")).Month)
                        dr("prExp") = prExp
                        dr("toExp") = toExp
                        dr("totExp") = -(prExp + toExp)
                        If CLng(dr("tokanno")) <> 0 Then
                            maintable.Rows.Add(dr)
                        End If
                        'maintable.Rows.Add(dr)
                    End If
            Next
            If maintable.Rows.Count > 0 Then
                dtanalysisData = sel_analysis()
                If maintable.Compute("count(tokanno)", "last=0") > 0 Then
                    get_ltp(maintable)
                End If
            End If
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub
    Private Sub fill_equity_dtable()
        pmaintable = dtable
        Dim objStrfo As Struct_FOContract
        Dim dr As DataRow
        Dim prExp, toExp As Double
        For Each drow As DataRow In eqtable.Rows
            dr = pmaintable.NewRow()
            dr("strikes") = 0
            dr("cp") = "E"
            dr("prqty") = drow("prqty")
            dr("toqty") = drow("toqty")
            dr("units") = Val(drow("qty"))
            dr("traded") = Val(drow("rate"))
            dr("last") = 0
            dr("flast") = 0
            dr("last1") = 0
            dr("lv") = 0
            dr("MktVol") = 0
            dr("lv1") = 0
            dr("company") = CStr(drow("company"))
            dr("script") = CStr(drow("script"))
            dr("mdate") = Today
            dr("entrydate") = CDate(drow("entrydate")).Date
            dr("token1") = 0
            dr("isliq") = False
            dr("tokanno") = CStr(drow("tokanno"))
            Dim asset_tokan As Double = 0

            If Not HT_FOContrct(drow("script").ToString().ToUpper()) Is Nothing Then
                objStrfo = HT_FOContrct(drow("script").ToString().ToUpper())
                'dblltsize = objStrfo.lotsize
                'token = objStrfo.Token
                asset_tokan = objStrfo.asset_tokan
                'Else
                '    dblltsize = 0
                '    token = 0
            End If
            dr("asset_tokan") = asset_tokan 'CStr(drow("asset_tokan"))

            Dim Drcpf() As DataRow = cpfmaster.Select("Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX') AND expdate1 >= #" & Format(Today, "dd-MMM-yyyy") & "#", "expdate1")
            If Drcpf.Length > 0 Then
                dr("ftoken") = Drcpf(0)("token")
                dr("fut_mdate") = Drcpf(0)("expDate1")
            Else
                dr("ftoken") = 0
                dr("fut_mdate") = Today
            End If

            dr("status") = 1
            prExp = 0
            toExp = 0
            Call cal_position_expense(dr, prExp, toExp, "EQ")
            dr("prExp") = prExp
            dr("toExp") = toExp
            dr("totExp") = -(prExp + toExp)
            pmaintable.Rows.Add(dr)
        Next

        'fill maintable
        maintable.Clear()

        For Each row As DataRow In pmaintable.Rows
            dr = maintable.NewRow
            dr("strikes") = row("strikes")
            dr("cp") = row("cp")
            dr("prqty") = row("prqty")
            dr("toqty") = row("toqty")
            dr("units") = row("units")
            dr("traded") = row("traded")
            dr("last") = row("last")
            dr("flast") = row("flast")
            dr("last1") = row("last1")
            dr("lv") = row("lv")
            dr("MktVol") = row("MktVol")
            dr("lv1") = 0 'row("lv1")
            dr("company") = row("company")
            dr("script") = row("script")
           
            dr("mdate") = row("mdate")
            dr("entrydate") = row("entrydate")
            dr("token1") = row("token1")
            dr("isliq") = row("isliq")
            dr("tokanno") = row("tokanno")
            Dim asset_tokan As Double = 0

            If Not HT_FOContrct(dr("script").ToString().ToUpper()) Is Nothing Then
                objStrfo = HT_FOContrct(dr("script").ToString().ToUpper())
                'dblltsize = objStrfo.lotsize
                'token = objStrfo.Token
                asset_tokan = objStrfo.asset_tokan
                'Else
                '    dblltsize = 0
                '    token = 0
            End If
            dr("asset_tokan") = asset_tokan ' Val(row("asset_tokan") & "")
            
            dr("ftoken") = row("ftoken")
            dr("fut_mdate") = IIf(IsDBNull(row("fut_mdate")) = True, row("mdate"), row("fut_mdate"))

            dr("status") = 1
            'extra values
            dr("delta") = 0
            dr("deltaval") = 0
            dr("deltaval1") = 0
            If dr("cp") = "F" Or dr("cp") = "E" Then
                dr("delta") = 1
                dr("deltaval") = dr("units")
                dr("deltaval1") = dr("units")
            Else
                dr("delta") = 0
                dr("deltaval") = 0
                dr("deltaval1") = 0
            End If

            dr("theta") = 0
            dr("thetaval") = 0
            dr("vega") = 0
            dr("vgval") = 0
            dr("vgval1") = 0
            dr("gamma") = 0
            dr("gmval") = 0
            dr("gmval1") = 0
            dr("volga") = 0
            dr("vanna") = 0
            dr("volgaval") = 0
            dr("vannaval") = 0
            dr("volgaval1") = 0
            dr("vannaval1") = 0
            dr("mdate_months") = (CDate(row("mdate")).Year * 12) + (CDate(row("mdate")).Month)
            If Not dr("cp") = "E" Then
                dr("month") = (Format(CDate(row("mdate")), "MMM yy"))
            End If


            dr("toatp") = 0
            dr("pratp") = 0
            dr("prExp") = row("prExp")
            dr("toExp") = row("toExp")
            dr("totExp") = row("totExp")
            If Currencymaster.Select("Script='" & row("script") & "'").Length > 0 Then
                dr("IsCurrency") = True
                dr("Lots") = dr("units") / Currencymaster.Compute("MAX(multiplier)", "Script='" & dr("Script") & "'")
                'Jignesh
                dr("ftoken") = Val(Currencymaster.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# AND option_type='XX'").ToString)
                If dr("ftoken") = 0 Then
                    Dim DtFMonthDate1 As DataTable = New DataView(Currencymaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                    If DtFMonthDate1.Rows.Count > 0 Then
                        dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                        dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                    Else
                        Dim DtFMonthDate As DataTable = New DataView(Currencymaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                        If DtFMonthDate.Rows.Count > 0 Then
                            If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                            End If
                        End If
                    End If


                    
                End If
                ElseIf cpfmaster.Select("Script='" & row("script") & "'").Length > 0 Then
                    dr("IsCurrency") = False
                    dr("Lots") = dr("units") / cpfmaster.Compute("MAX(lotsize)", "script = '" & dr("script") & "'")

                    'Jignesh
                    dr("ftoken") = Val(cpfmaster.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')").ToString)
                If dr("ftoken") = 0 Then

                    Dim DtFMonthDate1 As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                    If DtFMonthDate1.Rows.Count > 0 Then
                        dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                        dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                    Else
                        Dim DtFMonthDate As DataTable = New DataView(cpfmaster, "Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                        If DtFMonthDate.Rows.Count > 0 Then
                            If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                            End If
                        End If
                    End If

                  
                End If
                Else
                    dr("IsCurrency") = False
                    dr("Lots") = 0
                End If

            dr("IsVolFix") = CBool(IIf(IsDBNull(row("IsVolFix")), False, row("IsVolFix")))

            dr("DeltaN") = row("DeltaN")
            dr("GammaN") = row("GammaN")
            dr("VegaN") = row("VegaN")
            dr("ThetaN") = row("ThetaN")
            dr("VolgaN") = row("VolgaN")
            dr("VannaN") = row("VannaN")

            dr("IsCalc") = CBool(IIf(IsDBNull(row("IsCalc")), False, row("IsCalc")))

            dr("preQty") = row("preQty")
            dr("preDate") = row("preDate")
            dr("preSpot") = row("preSpot")
            dr("preVol") = row("preVol")
            dr("preDelVal") = row("preDelVal")
            dr("preVegVal") = row("preVegVal")
            dr("preTheVal") = row("preTheVal")

            dr("curSpot") = row("curSpot")
            dr("curVol") = row("curVol")
            dr("curDelVal") = row("curDelVal")
            dr("curVegVal") = row("curVegVal")
            dr("curTheVal") = row("curTheVal")

            dr("preTotalMTM") = row("preTotalMTM")
            dr("preGrossMTM") = row("preGrossMTM")
            dr("curTotalMTM") = row("curTotalMTM")
            dr("curGrossMTM") = row("curGrossMTM")

            If CLng(dr("tokanno")) <> 0 Then
                maintable.Rows.Add(dr)
            End If
        Next

        For Each row As DataRow In maintable.Rows
            If IsDBNull(row("ISVolFix")) Then
                row("ISVolFix") = False
            End If
        Next

        For Each row As DataRow In pmaintable.Rows
            If IsDBNull(row("ISVolFix")) Then
                row("ISVolFix") = False
            End If
        Next
        
        dtanalysisData = sel_analysis()
        get_ltp(maintable)
        get_ltp(pmaintable)
        delete_analysis()
        insert_analysis(pmaintable)
    End Sub
    Public Sub get_ltp(ByVal table As DataTable)
        Dim tik As Long = System.Environment.TickCount

        Dim noday As Integer
        If UCase(WeekdayName(Weekday(Now))) = "MONDAY" Then
            noday = 3
        Else
            noday = 1
        End If
        Dim scriptable As New DataTable
        scriptable = cpfmaster
        'Mrateofinterast = Val(GdtSettings.Compute("max(SettingKey)", "SettingName='Rateofinterest'").ToString)
        'bhavcopy = objBhav.select_data
        'GdtCompanyAnalysis = objTrad.select_company_ana
        'dtanalysis = sel_analysis()
        Dim chk As Boolean = False
        Dim chk1 As Boolean = False
        Dim mt As Double
        Dim futval As Double
        Dim iscall As Boolean



        If dtanalysisData.Rows.Count > 0 Then
            Dim DRTable() As DataRow = table.Select("")
            For Each row As DataRow In DRTable
                If IsDBNull(row("ISVolFix")) Then
                    row("ISVolFix") = False
                End If
            Next
            Dim dtcnttok As Double
            '   dtcnttok = DtAnalysis.Select("entrydate='" & Now.Date & "'").Length()
            dtcnttok = DtAnalysis.Compute("count(tokanno)", "entrydate='" & Now.Date & "'")
            'If DtAnalysis.Compute("count(tokanno)", "entrydate='" & Now.Date & "'") > 0 Then
            If dtcnttok > 0 Then
                chk = True
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if today data exist in analysis table then get ltp
                ' and vol from that table

                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                For Each row As DataRow In table.Rows
                    For Each drow As DataRow In dtanalysisData.Select("script='" & row("script") & "' and tokanno=" & CLng(row("tokanno")) & " And company='" & row("company") & "'")
                        row("last") = drow("ltp")
                        row("last1") = drow("ltp1")
                        If CBool(row("ISVolFix")) = False Then
                            row("lv") = drow("vol")
                            row("MktVol") = drow("MktVol")
                            row("lv1") = drow("vol1")
                        End If

                        row("status") = 1
                    Next
                Next
            ElseIf dtanalysisData.Compute("count(tokanno)", "entrydate='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if today data does not exist then 
                ' chek for day befor data in analysis table 
                'if that data exist then get ltp
                ' and vol from that table

                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                chk = True
                chk1 = True
                For Each row As DataRow In table.Rows
                    For Each drow As DataRow In dtanalysisData.Select("script='" & row("script") & "' and tokanno=" & CLng(row("tokanno")) & " And company='" & row("company") & "'")
                        row("last") = drow("ltp")
                        row("last1") = drow("ltp1")
                        If CBool(row("ISVolFix")) = False Then
                            row("lv") = drow("vol")
                            row("MktVol") = drow("MktVol")
                            row("lv1") = drow("vol1")
                        End If
                        row("status") = 1
                    Next
                Next
            End If
        End If
        If chk = True Then
            If chk1 = True And GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if ltp and vol get from anylysis table day before data then
                'check bhavcopy data for today date then get ltp from bhavcopy 
                'and calculate vol
                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                chk = True
                For Each row As DataRow In table.Rows
                    For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                        If row("cp") = "C" Or row("CP") = "P" Then
                            row("last") = drow("ltp")
                            row("last1") = 0
                            'If row("cp") = "C" Then
                            '    iscall = True
                            'Else
                            '    iscall = False
                            'End If
                            'futval = 0
                            'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                            '    futval = dr("ltp")
                            'Next
                            'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                            'If mt = 0 Then
                            '    mt = 0.0001
                            'Else
                            '    mt = (mt) / 365
                            'End If
                            'If futval > 0 Then
                            If CBool(row("ISVolFix")) = False Then
                                row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                row("MktVol") = drow("vol")
                                row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            End If
                            If row("isliq") = True Then
                                For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                    For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                        row("last1") = drow1("ltp")
                                        row("lv") = drow1("vol")
                                        row("MktVol") = drow1("vol")
                                    Next

                                Next
                                row("lv1") = drow("vol")

                            End If
                            'End If

                        Else
                            row("last") = drow("ltp")
                            row("last1") = 0
                            row("lv") = 0
                            row("MktVol") = 0
                            row("lv1") = 0

                        End If

                        row("status") = 1
                    Next
                Next
            ElseIf chk1 = True And GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if ltp and vol get from anylysis table day before data then
                'check bhavcopy data for day before date then get ltp from bhavcopy 
                'and calculate vol
                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                chk = True
                For Each row As DataRow In table.Rows
                    For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                        If row("cp") = "C" Or row("CP") = "P" Then
                            row("last") = drow("ltp")
                            row("last1") = 0
                            'If row("cp") = "C" Then
                            '    iscall = True
                            'Else
                            '    iscall = False
                            'End If
                            'futval = 0
                            'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                            '    futval = dr("ltp")
                            'Next
                            'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                            'If mt = 0 Then
                            '    mt = 0.0001
                            'Else
                            '    mt = (mt) / 365
                            'End If
                            ' If futval > 0 Then



                            If CBool(row("ISVolFix")) = False Then
                                row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                row("MktVol") = drow("vol")
                                row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            End If

                            If row("isliq") = True Then
                                For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                    For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                        row("last1") = drow1("ltp")
                                        row("lv") = drow1("vol")
                                        row("MktVol") = drow1("vol")
                                    Next

                                Next
                                row("lv1") = drow("vol")

                            End If
                            'End If
                        Else
                            row("last") = drow("ltp")
                            row("last1") = 0
                            row("lv") = 0
                            row("MktVol") = 0
                            row("lv1") = 0
                        End If
                        row("status") = 1
                    Next
                Next
            ElseIf table.Compute("count(tokanno)", "last =0") > 0 Then
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if ltp and vol get from anylysis table today data and check any script ltp remaining 0 then
                'check bhavcopy data for today date then get ltp from bhavcopy 
                'and calculate vol
                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                If GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
                    For Each row As DataRow In table.Select("last=0")
                        For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "'and entry_date='" & Now.Date & "'")
                            If row("cp") = "C" Or row("CP") = "P" Then
                                row("last") = drow("ltp")
                                row("last1") = 0
                                'If row("cp") = "C" Then
                                '    iscall = True
                                'Else
                                '    iscall = False
                                'End If
                                'futval = 0
                                'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                                '    futval = dr("ltp")
                                'Next
                                'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                                'If mt = 0 Then
                                '    mt = 0.0001
                                'Else
                                '    mt = (mt) / 365
                                'End If
                                ' If futval > 0 Then
                                If CBool(row("ISVolFix")) = False Then
                                    row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                    row("MktVol") = drow("vol")  'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                    row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                End If
                                If row("isliq") = True Then
                                    For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                        For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                            row("last1") = drow1("ltp")
                                            row("lv") = drow1("vol")
                                            row("MktVol") = drow1("vol")
                                        Next

                                    Next
                                    row("lv1") = drow("vol")

                                End If
                                'End If
                            Else
                                row("last") = drow("ltp")
                                row("last1") = 0
                                row("lv") = 0
                                row("MktVol") = 0
                                row("lv1") = 0


                            End If

                            row("status") = 1
                        Next
                    Next
                ElseIf GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
                    For Each row As DataRow In table.Select("last=0")
                        For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "'and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                            If row("cp") = "C" Or row("CP") = "P" Then
                                row("last") = drow("ltp")
                                row("last1") = 0
                                'If row("cp") = "C" Then
                                '    iscall = True
                                'Else
                                '    iscall = False
                                'End If
                                'futval = 0
                                'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                                '    futval = dr("ltp")
                                'Next
                                'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                                'If mt = 0 Then
                                '    mt = 0.0001
                                'Else
                                '    mt = (mt) / 365
                                'End If
                                ' If futval > 0 Then
                                If CBool(row("ISVolFix")) = False Then
                                    row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                    row("MktVol") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                    row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                                End If
                                If row("isliq") = True Then
                                    For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                        For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                            row("last1") = drow1("ltp")
                                            row("lv") = drow1("vol")
                                            row("MktVol") = drow1("vol")
                                        Next

                                    Next
                                    row("lv1") = drow("vol")

                                End If
                                ' End If
                            Else
                                row("last") = drow("ltp")
                                row("last1") = 0
                                row("lv") = 0
                                row("MktVol") = 0
                                row("lv1") = 0

                            End If

                            row("status") = 1
                        Next
                    Next

                End If

            End If
        ElseIf chk = False And GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
            '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
            REM if  analysis data does not exist for today and day before then
            'check bhavcopy data for today date then get ltp from bhavcopy 
            'and calculate vol
            '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
            chk = True
            For Each row As DataRow In table.Rows
                For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "'and entry_date='" & Now.Date & "'")
                    If row("cp") = "C" Or row("CP") = "P" Then
                        row("last") = drow("ltp")
                        row("last1") = 0
                        'If row("cp") = "C" Then
                        '    iscall = True
                        'Else
                        '    iscall = False
                        'End If
                        'futval = 0
                        'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                        '    futval = dr("ltp")
                        'Next
                        'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                        'If mt = 0 Then
                        '    mt = 0.0001
                        'Else
                        '    mt = (mt) / 365
                        'End If
                        ' If futval > 0 Then
                        If CBool(row("ISVolFix")) = False Then
                            row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            row("MktVol") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                        End If
                        If row("isliq") = True Then
                            For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                    row("last1") = drow1("ltp")
                                    row("lv") = drow1("vol")
                                    row("MktVol") = drow1("vol")
                                Next

                            Next
                            row("lv1") = drow("vol")

                        End If
                        'End If
                    Else
                        row("last") = drow("ltp")
                        row("last1") = 0
                        row("lv") = 0
                        row("MktVol") = 0
                        row("lv1") = 0


                    End If

                    row("status") = 1
                Next
            Next
        ElseIf chk = False And GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
            '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
            REM if  analysis data does not exist for today and day before then
            'check bhavcopy data for day before date then get ltp from bhavcopy 
            'and calculate vol
            '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
            chk = True
            For Each row As DataRow In table.Rows
                For Each drow As DataRow In GdtBhavcopy.Select("script='" & row("script") & "'and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                    If row("cp") = "C" Or row("CP") = "P" Then
                        row("last") = drow("ltp")
                        row("last1") = 0
                        'If row("cp") = "C" Then
                        '    iscall = True
                        'Else
                        '    iscall = False
                        'End If
                        'futval = 0
                        'For Each dr As DataRow In bhavcopy.Select("symbol='" & row("company") & "' and (option_type='XX' or option_type='' or option_type='null')and exp_date='" & row("mdate") & "'")
                        '    futval = dr("ltp")
                        'Next
                        'mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                        'If mt = 0 Then
                        '    mt = 0.0001
                        'Else
                        '    mt = (mt) / 365
                        'End If
                        'If futval > 0 Then
                        If CBool(row("ISVolFix")) = False Then
                            row("lv") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            row("MktVol") = drow("vol") 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                            row("lv1") = 0 'Vol(futval, val(row("strikes")), val(drow("ltp")), mt, iscall, True) * 100
                        End If
                        If row("isliq") = True Then
                            For Each dr As DataRow In scriptable.Select("token=" & CLng(row("token1")) & "")
                                For Each drow1 As DataRow In GdtBhavcopy.Select("script='" & row("script") & "' and entry_date='" & Now.Date & "'")
                                    row("last1") = drow1("ltp")
                                    row("lv") = drow1("vol")
                                    row("MktVol") = drow1("vol")

                                Next

                            Next
                            row("lv1") = drow("vol")

                        End If
                        'End If
                    Else
                        row("last") = drow("ltp")
                        row("last1") = 0
                        row("lv") = 0
                        row("MktVol") = 0
                        row("lv1") = 0


                    End If

                    row("status") = 1
                Next
            Next
        End If
        If chk = True Then
            If table.Compute("count(tokanno)", "last =0") > 0 Then
                For Each row As DataRow In table.Select("last=0")
                    futval = 0
                    futval = Val(ltp_token(row("ftoken"), scriptable.Compute("max(script)", "token=" & CLng(Val(row("ftoken").ToString)) & "").ToString, row("company").ToString).ToString)


                    For Each drow As DataRow In GdtCompanyAnalysis.Select("company='" & row("company") & "'")
                        If row("cp") = "C" Then
                            'row("lv") = drow("call_vol")
                            row("lv1") = 0
                            row("last") = 0
                            iscall = True
                            mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                            If mt = 0 Then
                                mt = 0.0001
                            Else
                                mt = (mt) / 365
                            End If



                            If futval = 0 Then
                                If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                    futval = Val(drow("fut1"))
                                    row("lv") = drow("call_vol")
                                    row("MktVol") = drow("call_vol")
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                    futval = Val(drow("fut2"))
                                    row("lv") = drow("call_vol1")
                                    row("MktVol") = drow("call_vol1")
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                    futval = Val(drow("fut3"))
                                    row("lv") = drow("call_vol2")
                                    row("MktVol") = drow("call_vol2")
                                End If


                                'If CDate(row("mdate")).Date = CDate(drow("exp1")).Date Then
                                '    futval = val(drow("fut1"))
                                'ElseIf CDate(row("mdate")).Date = CDate(drow("exp2")).Date Then
                                '    futval = val(drow("fut2"))
                                'ElseIf CDate(row("mdate")).Date = CDate(drow("exp3")).Date Then
                                '    futval = val(drow("fut3"))
                                'End If
                            End If
                            row("last1") = 0
                            If futval > 0 And Val(drow("call_vol")) <> 0 Then

                                If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("put_vol")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol")), mt, False, True)

                                        row("lv") = Val(drow("put_vol"))
                                        row("MktVol") = Val(drow("put_vol"))
                                        row("lv1") = Val(drow("call_vol"))
                                    End If
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol1")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("put_vol1")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol1")), mt, False, True)

                                        row("lv") = Val(drow("put_vol1"))
                                        row("MktVol") = Val(drow("put_vol1"))
                                        row("lv1") = Val(drow("call_vol1"))
                                    End If
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol2")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("put_vol2")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol2")), mt, False, True)

                                        row("lv") = Val(drow("put_vol2"))
                                        row("MktVol") = Val(drow("put_vol2"))

                                        row("lv1") = Val(drow("call_vol2"))
                                    End If
                                End If

                            End If
                        ElseIf row("CP") = "P" Then
                            'row("lv") = drow("put_vol")
                            row("lv1") = 0
                            row("last") = 0
                            row("last1") = 0
                            iscall = True
                            mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                            If mt = 0 Then
                                mt = 0.0001
                            Else
                                mt = (mt) / 365
                            End If
                            iscall = False
                            If futval = 0 Then
                                If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                    futval = Val(drow("fut1"))
                                    row("lv") = drow("put_vol")
                                    row("MktVol") = drow("put_vol")
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                    futval = Val(drow("fut2"))
                                    row("lv") = drow("put_vol1")
                                    row("MktVol") = drow("put_vol1")
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                    futval = Val(drow("fut3"))
                                    row("lv") = drow("put_vol2")
                                    row("MktVol") = drow("put_vol2")
                                End If
                                'If CDate(row("mdate")).Date = CDate(drow("exp1")).Date Then
                                '    futval = val(drow("fut1"))
                                'ElseIf CDate(row("mdate")).Date = CDate(drow("exp2")).Date Then
                                '    futval = val(drow("fut2"))
                                'ElseIf CDate(row("mdate")).Date = CDate(drow("exp3")).Date Then
                                '    futval = val(drow("fut3"))
                                'End If
                            End If

                            If futval > 0 And Val(drow("put_vol")) <> 0 Then
                                If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("call_vol")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol")), mt, True, True)

                                        row("lv") = Val(drow("call_vol"))
                                        row("MktVol") = Val(drow("call_vol"))
                                        row("lv1") = Val(drow("put_vol"))
                                    End If
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol1")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("call_vol1")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol1")), mt, True, True)

                                        row("lv") = Val(drow("call_vol1"))
                                        row("MktVol") = Val(drow("call_vol1"))
                                        row("lv1") = Val(drow("put_vol1"))
                                    End If
                                ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                    row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol2")), mt, iscall, True)
                                    If row("isliq") = True And Val(drow("call_vol2")) <> 0 Then
                                        row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol2")), mt, True, True)

                                        row("lv") = Val(drow("call_vol2"))
                                        row("MktVol") = Val(drow("call_vol2"))
                                        row("lv1") = Val(drow("put_vol2"))
                                    End If
                                End If


                            End If



                        ElseIf row("cp") = "F" Then
                            If futval = 0 Then
                                If CDate(row("mdate")).Date = CDate(drow("exp1")).Date Then
                                    futval = Val(drow("fut1"))
                                ElseIf CDate(row("mdate")).Date = CDate(drow("exp2")).Date Then
                                    futval = Val(drow("fut2"))
                                ElseIf CDate(row("mdate")).Date = CDate(drow("exp3")).Date Then
                                    futval = Val(drow("fut3"))
                                End If
                            End If
                            row("last") = futval
                            row("lv") = 0
                            row("MktVol") = 0
                        ElseIf row("cp") = "E" Then
                            row("last") = 0
                            row("lv") = 0
                            row("MktVol") = 0

                        End If
                        row("status") = 1
                    Next
                Next
            End If
        Else
            '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
            REM if analysis data does not exist for today and day before and  
            ' if bhavcopy data does not exist for today date then 
            'get call_vol,put_vol and future value from Company_anlysis table
            'and calculate ltp
            '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
            For Each row As DataRow In table.Rows
                futval = 0
                futval = Val(ltp_token(row("ftoken"), scriptable.Compute("max(script)", "token=" & CLng(Val(row("ftoken").ToString)) & "").ToString, row("company").ToString).ToString)

                For Each drow As DataRow In GdtCompanyAnalysis.Select("company='" & row("company") & "'")
                    If row("cp") = "C" Then

                        row("lv1") = 0
                        row("last") = 0
                        row("last1") = 0
                        iscall = True
                        mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                        If mt = 0 Then
                            mt = 0.0001
                        Else
                            mt = (mt) / 365
                        End If
                        If futval = 0 Then
                            If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("call_vol")
                                End If
                                futval = Val(drow("fut1"))

                                row("MktVol") = drow("call_vol")
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("call_vol1")
                                End If
                                futval = Val(drow("fut2"))

                                row("MktVol") = drow("call_vol1")
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("call_vol2")
                                End If
                                futval = Val(drow("fut3"))

                                row("MktVol") = drow("call_vol2")
                            End If
                        End If
                        If futval > 0 And Val(drow("call_vol")) <> 0 Then
                            If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("put_vol")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol")), mt, False, True)
                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("put_vol"))
                                    End If

                                    row("MktVol") = Val(drow("put_vol"))
                                    row("lv1") = Val(drow("call_vol"))
                                End If
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol1")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("put_vol1")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol1")), mt, False, True)
                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("put_vol1"))
                                    End If

                                    row("MktVol") = Val(drow("put_vol1"))
                                    row("lv1") = Val(drow("call_vol1"))
                                End If
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("call_vol2")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("put_vol2")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("put_vol2")), mt, False, True)
                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("put_vol2"))
                                    End If

                                    row("MktVol") = Val(drow("put_vol2"))
                                    row("lv1") = Val(drow("call_vol2"))
                                End If
                            End If


                        End If
                    ElseIf row("CP") = "P" Then
                        'row("lv") = drow("put_vol")
                        row("lv1") = 0
                        row("last") = 0
                        row("last1") = 0
                        iscall = True
                        mt = UDDateDiff(DateInterval.Day, Now.Date, CDate(row("mdate")).Date)
                        If mt = 0 Then
                            mt = 0.0001
                        Else
                            mt = (mt) / 365
                        End If
                        iscall = False
                        If futval = 0 Then


                            If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                futval = Val(drow("fut1"))
                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("put_vol")
                                End If

                                row("MktVol") = drow("put_vol")
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                futval = Val(drow("fut2"))

                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("put_vol1")
                                End If
                                row("MktVol") = drow("put_vol1")
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                futval = Val(drow("fut3"))

                                If row("ISVolFix") Then
                                    row("lv") = row("lv")
                                Else
                                    row("lv") = drow("put_vol1")
                                End If
                                row("MktVol") = drow("put_vol1")
                            End If

                            'If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                            '    futval = val(drow("fut1"))
                            'ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                            '    futval = val(drow("fut2"))
                            'ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                            '    futval = val(drow("fut3"))
                            'End If
                        End If
                        If futval > 0 And Val(drow("put_vol")) <> 0 Then
                            If CDate(row("fut_mdate")).Date = CDate(drow("exp1")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("call_vol")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol")), mt, True, True)

                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("call_vol"))
                                    End If
                                    row("MktVol") = Val(drow("call_vol"))
                                    row("lv1") = Val(drow("put_vol"))
                                End If
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp2")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol1")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("call_vol1")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol1")), mt, True, True)
                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("call_vol1"))
                                    End If

                                    row("MktVol") = Val(drow("call_vol1"))
                                    row("lv1") = Val(drow("put_vol1"))
                                End If
                            ElseIf CDate(row("fut_mdate")).Date = CDate(drow("exp3")).Date Then
                                row("last") = ltp(futval, Val(row("strikes")), Val(drow("put_vol2")), mt, iscall, True)
                                If row("isliq") = True And Val(drow("call_vol2")) <> 0 Then
                                    row("last1") = ltp(futval, Val(row("strikes")), Val(drow("call_vol2")), mt, True, True)
                                    If row("ISVolFix") Then
                                        row("lv") = row("lv")
                                    Else
                                        row("lv") = Val(drow("call_vol2"))
                                    End If

                                    row("MktVol") = Val(drow("call_vol2"))
                                    row("lv1") = Val(drow("put_vol2"))
                                End If
                            End If


                        End If
                    ElseIf row("cp") = "F" Then
                        If futval = 0 Then
                            If CDate(row("mdate")).Date = CDate(drow("exp1")).Date Then
                                futval = Val(drow("fut1"))
                            ElseIf CDate(row("mdate")).Date = CDate(drow("exp2")).Date Then
                                futval = Val(drow("fut2"))
                            ElseIf CDate(row("mdate")).Date = CDate(drow("exp3")).Date Then
                                futval = Val(drow("fut3"))
                            End If
                        End If
                        row("last") = futval
                        row("lv") = 0
                        row("MktVol") = 0
                    ElseIf row("cp") = "E" Then
                        row("last") = 0
                        row("lv") = 0
                        row("MktVol") = 0
                    End If
                    row("status") = 1
                Next
            Next
        End If

        Write_TradeLog_viral("get_ltp", tik, System.Environment.TickCount)
    End Sub
    
    Public Function fill_table_process(ByVal script As String, ByVal qty As Integer, ByVal rate As Double, ByRef prExp As Double, ByRef toExp As Double, ByVal entrydt As Date, ByVal sCompName As String) As DataTable
        init_table()
        Dim tmdtable As New DataTable
        Dim remarks As String = ""
        tmdtable = dtable.Clone
        scripttable = cpfmaster
        eqsecurity = eqmaster
        CurrScript = Currencymaster
        Dim dr As DataRow
        '  Dim count As Integer
        ' Dim ar As New ArrayList
        Dim table As New DataTable
        table = GdtFOTrades ' objTrad.Trading
        Dim CurrTable As New DataTable
        CurrTable = GdtCurrencyTrades REM Currency Trades
        tmdtable.Rows.Clear()

        Dim DrTrades() As DataRow = table.Select("script='" & script & "' And company='" & sCompName & "'")
        If DrTrades.Length > 0 Then
            For Each drow As DataRow In DrTrades
                'if position already in maintable, take token1 , ftoken from maintable
                Dim mrow1(), mrow As DataRow
                mrow1 = maintable.Select("script = '" & script & "' And company='" & sCompName & "'", "")
                If Not mrow1 Is Nothing Then
                    If mrow1.Length <> 0 Then
                        mrow = mrow1(0)
                        remarks = mrow("remarks").ToString
                        If entrydt = Today.Date Then
                            toExp += Val(mrow("toExp").ToString)
                            prExp = Val(mrow("prExp").ToString)
                        Else
                            toExp = Val(mrow("toExp").ToString)
                            prExp += Val(mrow("prExp").ToString)
                        End If

                        'Dim srate, brate As Double
                        Dim netprice As Double = 0
                        dr = tmdtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        If CDate(drow("entry_date")) < Today Then
                            dr("prqty") = Val(mrow("prqty")) + qty ' Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < '" & Today & "'").ToString)
                            dr("toqty") = Val(mrow("toqty"))
                        Else
                            dr("prqty") = Val(mrow("prqty"))
                            dr("toqty") = Val(mrow("toqty")) + qty 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= '" & Today & "' ").ToString)
                        End If
                        netprice = Val(mrow("traded")) * Val(mrow("units"))
                        dr("units") = Val(mrow("units")) + qty 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'"))

                        If Val(dr("units")) = 0 Then
                            Dim brate, srate As Double
                            srate = -Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString)
                            brate = Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
                            netprice = Math.Round(brate - srate, 2)
                        Else
                            Dim VarTotAmount As Double = Val(table.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                            'netprice = netprice / Val(dr("units"))
                            'netprice += (qty * rate) / Val(dr("units"))
                            netprice = VarTotAmount / dr("units")
                        End If

                        dr("traded") = netprice
                        'srate = -Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0 ").ToString)
                        'brate = Val(table.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0 ").ToString)
                        'If Val(dr("units")) = 0 Then
                        ' dr("traded") = Math.Round(brate - srate, 2)
                        'Else
                        '   dr("traded") = Math.Round((brate - srate) / Val(dr("units")), 2)
                        'End If

                        dr("last") = 0
                        dr("flast") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("fut_mdate") = CDate(drow("mdate"))
                        dr("entrydate") = CDate(drow("entrydate")).Date
                        dr("token1") = drow("token1")
                        dr("asset_tokan") = 0 'HT_AssetToken(CLng(drow("token1"))) ' 0 'drow("asset_tokan")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("IsCalc") = True
                        dr("tokanno") = mrow("tokanno")
                        dr("ftoken") = mrow("ftoken")
                        dr("remarks") = remarks
                        dr("prExp") = prExp
                        dr("toExp") = toExp
                        dr("status") = 1
                        dr("IsVolFix") = CBool(mrow("IsVolFix"))

                        dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                        'If CLng(dr("tokanno")) <> 0 Then

                        dr("preQty") = 0
                        dr("preDate") = Now.Date
                        dr("preSpot") = 0
                        dr("preVol") = 0
                        dr("preDelVal") = 0
                        dr("preVegVal") = 0
                        dr("preTheVal") = 0
                        dr("curVol") = 0
                        dr("curSpot") = 0
                        dr("curDelVal") = 0
                        dr("curVegVal") = 0
                        dr("curTheVal") = 0

                        dr("preTotalMTM") = 0
                        dr("preGrossMTM") = 0
                        dr("curTotalMTM") = 0
                        dr("curGrossMTM") = 0

                        tmdtable.Rows.Add(dr)
                        'End If
                    Else
                        dr = tmdtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        If CDate(drow("entry_date")) < Today Then
                            dr("prqty") = qty
                            dr("toqty") = 0
                        Else
                            dr("prqty") = 0
                            dr("toqty") = qty
                        End If
                        dr("units") = qty
                        'dr("lots") = Val(dr("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & script & "'")
                        dr("traded") = rate
                        dr("last") = 0
                        dr("flast") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("entrydate") = CDate(drow("entrydate")).Date
                        dr("token1") = drow("token1")
                        If HT_AssetToken.Contains(CLng(drow("token1"))) = True Then
                            dr("asset_tokan") = Val(HT_AssetToken(CLng(drow("token1"))) & "")
                        Else
                            dr("asset_tokan") = 0

                        End If
                        '0 'drow("asset_tokan")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("IsCalc") = True
                        dr("tokanno") = Val(scripttable.Compute("max(token)", "script='" & drow("script") & "'").ToString)
                        dr("ftoken") = Val(scripttable.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#  AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')").ToString)
                        If dr("ftoken") = 0 Then

                            Dim DtFMonthDate1 As DataTable = New DataView(scripttable, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'and expdate1>=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "#", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If DtFMonthDate1.Rows.Count > 0 Then
                                dr("ftoken") = DtFMonthDate1.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate1.Rows(0)("expdate1")
                            Else
                                Dim DtFMonthDate As DataTable = New DataView(scripttable, "Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                                If DtFMonthDate.Rows.Count > 0 Then
                                    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                        dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" Then
                                        dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                                    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" Then
                                        dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                                    End If
                                End If
                            End If

                          
                        Else
                            dr("fut_mdate") = CDate(drow("mdate"))
                        End If
                            dr("status") = 1
                            dr("remarks") = remarks
                            dr("prExp") = prExp
                            dr("toExp") = toExp
                            dr("IsVolFix") = False

                            dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                            dr("preQty") = 0
                            dr("preDate") = Now.Date
                            dr("preSpot") = 0
                            dr("preVol") = 0
                            dr("preDelVal") = 0
                            dr("preVegVal") = 0
                            dr("preTheVal") = 0
                            dr("curVol") = 0
                            dr("curSpot") = 0
                            dr("curDelVal") = 0
                            dr("curVegVal") = 0
                            dr("curTheVal") = 0

                            dr("preTotalMTM") = 0
                            dr("preGrossMTM") = 0
                            dr("curTotalMTM") = 0
                            dr("curGrossMTM") = 0

                            If CLng(dr("tokanno")) <> 0 Then
                                tmdtable.Rows.Add(dr)
                            End If
                        End If
                End If
                Exit For
            Next
        Else REM Currency Script
            DrTrades = CurrTable.Select("script='" & script & "' And company='" & sCompName & "'")
            For Each drow As DataRow In DrTrades
                'if position already in maintable, take token1 , ftoken from maintable
                Dim mrow1(), mrow As DataRow
                mrow1 = maintable.Select("script = '" & script & "' And company='" & sCompName & "'", "")
                If Not mrow1 Is Nothing Then
                    If mrow1.Length <> 0 Then
                        mrow = mrow1(0)
                        remarks = mrow("remarks").ToString
                        If entrydt = Today.Date Then
                            toExp += Val(mrow("toExp").ToString)
                            prExp = Val(mrow("prExp").ToString)
                        Else
                            toExp = Val(mrow("toExp").ToString)
                            prExp += Val(mrow("prExp").ToString)
                        End If

                        'Dim srate, brate As Double
                        Dim netprice As Double = 0
                        dr = tmdtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        If CDate(drow("entry_date")) < Today Then
                            dr("prqty") = Val(mrow("prqty")) + qty ' Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < '" & Today & "'").ToString)
                            dr("toqty") = Val(mrow("toqty"))
                        Else
                            dr("prqty") = Val(mrow("prqty"))
                            dr("toqty") = Val(mrow("toqty")) + qty 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= '" & Today & "' ").ToString)
                        End If
                        netprice = Val(mrow("traded")) * Val(mrow("units"))
                        dr("units") = Val(mrow("units")) + qty 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'"))

                        If Val(dr("units")) = 0 Then
                            Dim brate, srate As Double
                            srate = -Val(CurrTable.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString)
                            brate = Val(CurrTable.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
                            netprice = Math.Round(brate - srate, 2)
                        Else
                            Dim VarTotAmount As Double = Val(CurrTable.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                            'netprice = netprice / Val(dr("units"))
                            'netprice += (qty * rate) / Val(dr("units"))
                            netprice = VarTotAmount / dr("units")
                        End If

                        dr("traded") = netprice

                        dr("last") = 0
                        dr("flast") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("fut_mdate") = CDate(drow("mdate"))
                        dr("entrydate") = CDate(drow("entrydate")).Date
                        dr("token1") = drow("token1")
                        dr("asset_tokan") = 0 'drow("asset_tokan")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("IsCalc") = True
                        dr("tokanno") = mrow("tokanno")
                        dr("ftoken") = mrow("ftoken")
                        dr("remarks") = remarks
                        dr("prExp") = prExp
                        dr("toExp") = toExp
                        dr("status") = 1
                        If IsDBNull(mrow("IsVolFix")) Then mrow("IsVolFix") = False
						dr("IsVolFix") = CBool(mrow("IsVolFix"))
                        If CBool(dr("IsVolFix")) Then
                            dr("last") = mrow("last")
                            dr("lv") = mrow("lv")
                            dr("MktVol") = mrow("lv")
                        End If

                        dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                        dr("preQty") = 0
                        dr("preDate") = Now.Date
                        dr("preSpot") = 0
                        dr("preVol") = 0
                        dr("preDelVal") = 0
                        dr("preVegVal") = 0
                        dr("preTheVal") = 0
                        dr("curVol") = 0
                        dr("curSpot") = 0
                        dr("curDelVal") = 0
                        dr("curVegVal") = 0
                        dr("curTheVal") = 0

                        dr("preTotalMTM") = 0
                        dr("preGrossMTM") = 0
                        dr("curTotalMTM") = 0
                        dr("curGrossMTM") = 0

                        'If CLng(dr("tokanno")) <> 0 Then
                        tmdtable.Rows.Add(dr)
                        'End If
                    Else
                        dr = tmdtable.NewRow()
                        dr("strikes") = Val(drow("strikerate"))
                        If CDate(drow("entry_date")) < Today Then
                            dr("prqty") = qty
                            dr("toqty") = 0
                        Else
                            dr("prqty") = 0
                            dr("toqty") = qty
                        End If
                        dr("units") = qty
                        'dr("lots") = Val(dr("units")) / cpfmaster.Compute("MAX(lotsize)", "script = '" & script & "'")
                        dr("traded") = rate
                        dr("last") = 0
                        dr("flast") = 0
                        dr("last1") = 0
                        dr("lv") = 0
                        dr("MktVol") = 0
                        dr("lv1") = 0
                        dr("cp") = drow("cp")
                        If Not IsDBNull(drow("cp")) Then
                            If drow("cp") = "C" Then
                                dr("Cp") = "C"
                            ElseIf drow("cp") = "P" Then
                                dr("Cp") = "P"
                            Else
                                dr("Cp") = "F"
                            End If
                        Else
                            dr("Cp") = "F"
                        End If
                        dr("company") = CStr(drow("company"))
                        dr("script") = CStr(drow("script"))
                        dr("mdate") = CDate(drow("mdate"))
                        dr("entrydate") = CDate(drow("entrydate")).Date
                        dr("token1") = drow("token1")
                        dr("asset_tokan") = 0 'drow("asset_tokan")
                        dr("isliq") = CBool(drow("isliq"))
                        dr("IsCalc") = True
                        dr("tokanno") = Val(CurrScript.Compute("max(token)", "script='" & drow("script") & "'").ToString)
                        dr("ftoken") = Val(CurrScript.Compute("max(token)", "Symbol='" & GetSymbol(dr("company")) & "' and expdate1=#" & Format(dr("mdate"), "dd-MMM-yyyy") & "# and option_type='XX'").ToString)
                        If dr("ftoken") = 0 Then
                            Dim DtFMonthDate As DataTable = New DataView(CurrScript, "Symbol='" & GetSymbol(dr("company")) & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
                            If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(0)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(1)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
                            ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" Then
                                dr("ftoken") = DtFMonthDate.Rows(2)("token")
                                dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
                            End If
                        Else
                            dr("fut_mdate") = CDate(drow("mdate"))
                        End If
                        dr("status") = 1
                        dr("remarks") = remarks
                        dr("prExp") = prExp
                        dr("toExp") = toExp
                        dr("IsVolFix") = False

                        dr("DeltaN") = 0
                        dr("GammaN") = 0
                        dr("VegaN") = 0
                        dr("ThetaN") = 0
                        dr("VolgaN") = 0
                        dr("VannaN") = 0

                        dr("preQty") = 0
                        dr("preDate") = Now.Date
                        dr("preSpot") = 0
                        dr("preVol") = 0
                        dr("preDelVal") = 0
                        dr("preVegVal") = 0
                        dr("preTheVal") = 0
                        dr("curVol") = 0
                        dr("curSpot") = 0
                        dr("curDelVal") = 0
                        dr("curVegVal") = 0
                        dr("curTheVal") = 0

                        dr("preTotalMTM") = 0
                        dr("preGrossMTM") = 0
                        dr("curTotalMTM") = 0
                        dr("curGrossMTM") = 0

                        If CLng(dr("tokanno")) <> 0 Then
                            tmdtable.Rows.Add(dr)
                        End If

                    End If
                End If
                Exit For
            Next
        End If


        pmaintable.Rows.Clear()
        pmaintable = tmdtable
        dtanalysisData = sel_analysis()
        get_ltp(pmaintable)
        delete_analysis(script, sCompName)
        insert_analysis(pmaintable)
        Return pmaintable


    End Function

    Public Function fill_equity_process(ByVal script As String, ByVal qty As Integer, ByVal rate As Double, ByRef prExp As Double, ByRef toExp As Double, ByVal entrydt As Date, ByVal sCompName As String) As DataTable
        init_table()
        Dim tmdtable As New DataTable
        tmdtable = eqtable.Clone
        eqsecurity = eqmaster
        Dim remarks As String = ""
        Dim temtable As New DataTable
        temtable = GdtEQTrades 'objTrad.select_equity

        'Dim count As Integer
        Dim dr As DataRow
        'Dim ar As New ArrayList

        For Each drow As DataRow In temtable.Select("script='" & script & "' And company='" & sCompName & "'")
            Dim mrow1(), mrow As DataRow
            mrow1 = maintable.Select("script = '" & script & "' And company='" & sCompName & "'", "")
            If Not mrow1 Is Nothing Then
                If mrow1.Length <> 0 Then
                    mrow = mrow1(0)

                    remarks = mrow("remarks").ToString
                    If entrydt = Today.Date Then
                        toExp += Val(mrow("toExp").ToString)
                        prExp = Val(mrow("prExp").ToString)
                    Else
                        toExp = Val(mrow("toExp").ToString)
                        prExp += Val(mrow("prExp").ToString)
                    End If

                    'count = CInt(temtable.Compute("count(script)", "script='" & drow("script") & "'"))
                    'If count > 1 Then
                    'If Not ar.Contains(drow("script")) Then
                    Dim brate As Double = 0
                    Dim srate As Double = 0

                    '           ar.Add(drow("script"))
                    dr = tmdtable.NewRow()
                    dr("script") = drow("script")
                    dr("company") = drow("company")
                    dr("eq") = CStr(drow("eq"))
                    If drow("entry_date") < Today Then
                        dr("prqty") = Val(mrow("prqty")) + qty
                        dr("toqty") = Val(mrow("toqty"))
                    Else
                        dr("prqty") = Val(mrow("prqty"))
                        dr("toqty") = Val(mrow("toqty")) + qty
                    End If
                    Dim netprice As Double = 0
                    'If mrow("units") = 0 Then
                    'netprice = Val(mrow("traded"))
                    'Else
                    netprice = Val(mrow("traded")) * Val(mrow("units"))
                    'End If
                    dr("qty") = Val(mrow("units")) + qty 'Val(table.Compute("sum(qty)", "script='" & drow("script") & "'"))

                    'If Val(dr("qty")) = 0 Then
                    '    srate = -Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0 ").ToString)
                    '    brate = Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0 ").ToString)
                    '    netprice = Math.Round(brate - srate, 2)
                    'Else
                    '    netprice = netprice / Val(dr("qty"))
                    '    netprice += (qty * rate) / Val(dr("qty"))
                    'End If

                    If Val(dr("qty")) = 0 Then
                        srate = -Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0  And company='" & drow("company") & "'").ToString)
                        brate = Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0  And company='" & drow("company") & "'").ToString)
                        netprice = Math.Round(brate - srate, 2)
                    Else
                        Dim VarTotAmount As Double = Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' And company='" & drow("company") & "'").ToString)
                        'netprice = netprice / Val(dr("units"))
                        'netprice += (qty * rate) / Val(dr("units"))
                        netprice = VarTotAmount / dr("qty")
                    End If
                    dr("rate") = Math.Round(netprice, 2)
                    'srate = -Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot < 0 ").ToString)
                    'brate = Val(temtable.Compute("sum(tot)", "script='" & drow("script") & "' and tot > 0 ").ToString)
                    'If Val(dr("qty")) = 0 Then
                    '    dr("rate") = Math.Round(brate - srate, 2)
                    'Else
                    '    dr("rate") = Math.Round((brate - srate) / Val(dr("qty")), 2)
                    'End If


                    dr("entrydate") = CDate(drow("entrydate")).Date
                    For Each row As DataRow In eqsecurity.Select("script='" & drow("script") & "'")
                        dr("tokanno") = CStr(row("token"))
                        '=====================================keval
                        'dr("asset_tokan") = 0 'CStr(row("asset_tokan"))
                        '========================================
                        tmdtable.Rows.Add(dr)
                    Next

                Else
                    dr = tmdtable.NewRow()
                    dr("script") = drow("script")
                    dr("company") = drow("company")
                    dr("eq") = CStr(drow("eq"))
                    If drow("entry_date") < Today Then
                        dr("prqty") = qty
                        dr("toqty") = 0
                    Else
                        dr("prqty") = 0
                        dr("toqty") = qty
                    End If
                    'dr("prqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date < '" & Today & "'").ToString)
                    'dr("toqty") = Val(temtable.Compute("sum(qty)", "script='" & drow("script") & "' and entry_date >= '" & Today & "'").ToString)

                    dr("qty") = qty
                    dr("rate") = rate
                    'dr("uid") = CInt(drow("uid"))
                    dr("entrydate") = CDate(drow("entrydate")).Date
                    dr("entryno") = Val(drow("entryno"))
                    For Each row As DataRow In eqsecurity.Select("script='" & drow("script") & "'")
                        dr("tokanno") = CStr(row("token"))
                        tmdtable.Rows.Add(dr)
                    Next
                End If
            End If
            Exit For
        Next
        pmaintable.Rows.Clear()
        For Each drow As DataRow In tmdtable.Rows
            dr = pmaintable.NewRow()
            dr("strikes") = 0
            dr("cp") = "E"
            dr("prqty") = drow("prqty")
            dr("toqty") = drow("toqty")
            dr("units") = Val(drow("qty"))
            dr("traded") = Val(drow("rate"))
            dr("last") = 0
            dr("flast") = 0
            dr("last1") = 0
            dr("lv") = 0
            dr("MktVol") = 0
            dr("lv1") = 0
            dr("company") = CStr(drow("company"))
            dr("script") = CStr(drow("script"))
            dr("mdate") = Today
            dr("entrydate") = CDate(drow("entrydate")).Date
            dr("token1") = 0
            dr("isliq") = False
            dr("tokanno") = CStr(drow("tokanno"))
            'dr("ftoken") = 0

            If cpfmaster.Select("Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')").Length > 0 Then
                dr("fut_mdate") = cpfmaster.Compute("MIN(expDate1)", "Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX')")
                dr("ftoken") = cpfmaster.Compute("MAX(token)", "Symbol='" & GetSymbol(dr("company")) & "' AND InstrumentName IN ('FUTSTK','FUTIDX','FUTIVX') AND expdate1=#" & Format(dr("fut_mdate"), "dd-MMM-yyyy") & "#")
            Else
                dr("ftoken") = 0
                dr("fut_mdate") = Today
            End If


            'Dim DtFMonthDate As DataTable = New DataView(cpfmaster, "Symbol='" & drow("company") & "' AND option_type='XX'", "expdate1", DataViewRowState.CurrentRows).ToTable(True, "expdate1", "token")
            'If DtFMonthDate.Rows.Count > 0 Then
            '    If UCase(GVarMaturity_Far_month) = "CURRENT MONTH" And DtFMonthDate.Rows.Count = 1 Then
            '        dr("ftoken") = DtFMonthDate.Rows(0)("token")
            '        dr("fut_mdate") = DtFMonthDate.Rows(0)("expdate1")
            '    ElseIf UCase(GVarMaturity_Far_month) = "NEXT MONTH" And DtFMonthDate.Rows.Count = 2 Then
            '        dr("ftoken") = DtFMonthDate.Rows(1)("token")
            '        dr("fut_mdate") = DtFMonthDate.Rows(1)("expdate1")
            '    ElseIf UCase(GVarMaturity_Far_month) = "FAR MONTH" And DtFMonthDate.Rows.Count = 3 Then
            '        dr("ftoken") = DtFMonthDate.Rows(2)("token")
            '        dr("fut_mdate") = DtFMonthDate.Rows(2)("expdate1")
            '    End If
            'Else
            '    dr("ftoken") = 0
            '    dr("fut_mdate") = Today
            'End If
            dr("status") = 1
            dr("remarks") = remarks
            dr("prExp") = prExp
            dr("toExp") = toExp
            dr("IsVolFix") = False

            dr("DeltaN") = 0
            dr("GammaN") = 0
            dr("VegaN") = 0
            dr("ThetaN") = 0
            dr("VolgaN") = 0
            dr("VannaN") = 0

            dr("IsCalc") = True

            dr("preQty") = 0
            dr("preDate") = Now.Date
            dr("preSpot") = 0
            dr("preVol") = 0
            dr("preDelVal") = 0
            dr("preVegVal") = 0
            dr("preTheVal") = 0
            dr("curVol") = 0
            dr("curSpot") = 0
            dr("curDelVal") = 0
            dr("curVegVal") = 0
            dr("curTheVal") = 0

            dr("preTotalMTM") = 0
            dr("preGrossMTM") = 0
            dr("curTotalMTM") = 0
            dr("curGrossMTM") = 0

            pmaintable.Rows.Add(dr)
        Next
        dtanalysisData = sel_analysis()
        get_ltp(pmaintable)
        delete_analysis(script, sCompName)
        insert_analysis(pmaintable)
        Return pmaintable
    End Function

    Public Function sel_analysis() As DataTable
        Try
            data_access.ParamClear()
            data_access.Cmd_Text = SP_select_analysis
            data_access.cmd_type = CommandType.StoredProcedure
            Return data_access.FillList()
        Catch ex As Exception
            MsgBox(ex.ToString)
            Return Nothing
        End Try
    End Function
    'No Use Comment by payal(11-2-2016)
    'Public Function sel_analysis_maintable() As DataTable
    '    Try
    '        data_access.ParamClear()
    '        data_access.Cmd_Text = SP_select_analysis_maintable
    '        Return data_access.FillList()
    '    Catch ex As Exception
    '        MsgBox(ex.ToString)
    '        Return Nothing
    '    End Try
    'End Function
    'By Viral 2 Aug-2011
    Public Sub sel_analysis(ByRef Dt As DataTable)
        Try
            data_access.ParamClear()
            data_access.Cmd_Text = SP_select_analysis
            data_access.FillList(Dt)


        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub

    Public Sub UpdPreData_analysis()
        Try
            data_access.ParamClear()
            data_access.Cmd_Text = sp_update_PreDate
            data_access.ExecuteNonQuery()
        Catch ex As Exception
            MsgBox(ex.ToString)
        End Try
    End Sub

    Public Sub insert_analysis(ByVal detable As DataTable)
        data_access.ParamClear()
        For Each drow As DataRow In detable.Rows
            data_access.AddParam("@script", OleDbType.VarChar, 100, CStr(drow("Script")))
            data_access.AddParam("@strikerate", OleDbType.Double, 18, Val(drow("Strikes")))
            data_access.AddParam("@cp", OleDbType.VarChar, 18, CStr(drow("CP")))
            data_access.AddParam("@mdate", OleDbType.Date, 18, CDate(drow("Mdate")))
            data_access.AddParam("@company", OleDbType.VarChar, 50, CStr(drow("Company")))
            data_access.AddParam("@qty", OleDbType.Double, 18, Val(drow("units")))
            data_access.AddParam("@rate", OleDbType.Double, 18, Val(drow("traded")))
            data_access.AddParam("@entrydate", OleDbType.Date, 18, CDate(drow("EntryDate")))
            data_access.AddParam("@token1", OleDbType.Integer, 18, CInt(drow("token1")))
            data_access.AddParam("@isliq", OleDbType.Boolean, 18, (drow("isliq")))

            data_access.AddParam("@ltp", OleDbType.Double, 18, CStr(drow("last")))
            data_access.AddParam("@prqty", OleDbType.Double, 18, CStr(drow("prqty")))
            data_access.AddParam("@toqty", OleDbType.Double, 18, CStr(drow("toqty")))
            data_access.AddParam("@status", OleDbType.Integer, 18, CStr(drow("status").ToString))
            data_access.AddParam("@ftoken", OleDbType.Integer, 18, CStr(drow("ftoken")))
            data_access.AddParam("@tokanno", OleDbType.Integer, 18, CStr(drow("tokanno")))
            data_access.AddParam("@asset_tokan", OleDbType.Integer, 18, IIf(IsDBNull(drow("asset_tokan")), 0, drow("asset_tokan")))
            data_access.AddParam("@vol", OleDbType.Double, 18, CStr(drow("lv")))
            data_access.AddParam("@ltp1", OleDbType.Double, 18, Val(drow("last1").ToString))
            data_access.AddParam("@vol1", OleDbType.Double, 18, Val(CStr(drow("lv1").ToString)))

            data_access.AddParam("@remarks", OleDbType.VarChar, 250, drow("remarks").ToString)
            data_access.AddParam("@prexp", OleDbType.Double, 18, Val(drow("prExp").ToString))
            data_access.AddParam("@toexp", OleDbType.Double, 18, Val(drow("toExp").ToString))
            data_access.AddParam("@IsCalc", OleDbType.Boolean, 18, CBool(IIf(IsDBNull(drow("IsCalc")) = True, True, drow("IsCalc"))))
            data_access.AddParam("@preDate", OleDbType.Date, 18, CDate(IIf(IsDBNull(drow("preDate")), Today, drow("preDate"))))
            data_access.AddParam("@preSpot", OleDbType.Double, 18, Val(drow("preSpot").ToString & ""))
            data_access.AddParam("@preVol", OleDbType.Double, 18, Val(drow("preVol").ToString & ""))
            data_access.AddParam("@preDelVal", OleDbType.Double, 18, Val(drow("preDelVal").ToString & ""))
            data_access.AddParam("@preVegVal", OleDbType.Double, 18, Val(drow("preVegVal").ToString & ""))
            data_access.AddParam("@preTheVal", OleDbType.Double, 18, Val(drow("preTheVal").ToString & ""))

            data_access.AddParam("@curSpot", OleDbType.Double, 18, Val(drow("curSpot").ToString & ""))
            data_access.AddParam("@curVol", OleDbType.Double, 18, Val(drow("curVol").ToString & ""))
            data_access.AddParam("@curDelVal", OleDbType.Double, 18, Val(drow("curDelVal").ToString & ""))
            data_access.AddParam("@curVegVal", OleDbType.Double, 18, Val(drow("curVegVal").ToString & ""))
            data_access.AddParam("@curTheVal", OleDbType.Double, 18, Val(drow("curTheVal").ToString & ""))
            data_access.AddParam("@preTotalMTM", OleDbType.Double, 18, Val(drow("preTotalMTM").ToString & ""))
            data_access.AddParam("@preGrossMTM", OleDbType.Double, 18, Val(drow("preGrossMTM").ToString & ""))
            data_access.AddParam("@curTotalMTM", OleDbType.Double, 18, Val(drow("curTotalMTM").ToString & ""))
            data_access.AddParam("@curGrossMTM", OleDbType.Double, 18, Val(drow("curGrossMTM").ToString & ""))
            data_access.AddParam("@IsVolFix", OleDbType.Boolean, 18, CBool(IIf(IsDBNull(drow("IsVolFix")) = True, True, drow("IsVolFix"))))

            data_access.AddParam("@preQty", OleDbType.Double, 18, Val(drow("preQty").ToString & ""))
            data_access.AddParam("@fltp", OleDbType.Double, 18, Val(drow("flast") & ""))
            data_access.AddParam("@MktVol", OleDbType.Double, 18, Val(drow("MktVol").ToString & ""))

        Next
        data_access.Cmd_Text = SP_insert_analysis
        data_access.ExecuteMultiple(43)
    End Sub
    Public Sub delete_analysis()
        data_access.ParamClear()
        data_access.Cmd_Text = SP_delete_analysis
        data_access.ExecuteNonQuery()
    End Sub
    Public Sub delete_analysis(ByVal script As String, ByVal sCompname As String)
        data_access.ParamClear()
        data_access.AddParam("@script", OleDbType.VarChar, 100, CStr(script))
        'data_access.AddParam("@company", OleDbType.VarChar, 100, sCompname)
        data_access.Cmd_Text = SP_delete_analysis_script_company
        data_access.ExecuteNonQuery()
    End Sub
    Public Sub delete_analysis_company(ByVal company As String)
        data_access.ParamClear()
        data_access.AddParam("@company", OleDbType.VarChar, 50, CStr(company))
        data_access.Cmd_Text = "delete_analysis_script"
        data_access.ExecuteNonQuery()
    End Sub
    Public Function Vol(ByVal futval As Double, ByVal stkprice As Double, ByVal cpprice As Double, ByVal _mt As Double, ByVal mIsCall As Boolean, ByVal mIsFut As Boolean) As Double

        Dim tmpcpprice As Double = 0
        Dim mVolatility As Double
        tmpcpprice = cpprice
        'IF MATURITY IS 0 THEN _MT = 0.00001 

        mVolatility = Greeks.Black_Scholes(futval, stkprice, Mrateofinterast, 0, tmpcpprice, _mt, mIsCall, mIsFut, 0, 6)
        Return mVolatility
    End Function

    Private Function ltp(ByVal futval As Double, ByVal stkprice As Double, ByVal vol As Double, ByVal _mt As Double, ByVal mIsCall As Boolean, ByVal mIsFut As Boolean) As Double
        Dim tmpcpprice As Double = 0
        Dim mVolatility As Double
        Dim lv As Double
        If vol = 0 Then vol = 0.1
        lv = Val(vol / 100)
        'IF MATURITY IS 0 THEN _MT = 0.00001 
        If vol <> 0 Then
            mVolatility = Greeks.Black_Scholes(futval, stkprice, Mrateofinterast, 0, lv, _mt, mIsCall, mIsFut, 0, 0)
        Else
            mVolatility = 0
        End If
        Return mVolatility

    End Function
    Public Sub process_data_FO(ByVal table As DataTable)
        Call init_table()
        Call fill_table(table)   REM Directly Update Maintable 19-11-2010 by Divyesh 
        ''update_maintable(dtable, "FO")
    End Sub
    Public Sub process_data_EQ(ByVal temtable As DataTable)
        init_table()
        fill_equity(temtable) REM Directly Update Maintable 19-11-2010 by Divyesh
        'update_maintable(eqtable, "EQ")
    End Sub
    Public Sub process_data_Currency(ByVal table As DataTable)
        init_table()
        fill_Currency(table) REM Directly Update Maintable 19-11-2010 by Divyesh
        'update_maintable(dtable, "CURR")
    End Sub

    Public Sub process_data()
        init_table()
        dtable.Rows.Clear()
        Call fill_table()
        Call fill_equity()
        Call fill_Currency()

        REM Fill Expense Datatable - Alpesh
        Call Init_G_DTExpenseData()
        Call GSub_CalculateExpense(GdtFOTrades, "FO", True)
        'objTrad.Delete_Expense_Data_All()
        'objTrad.Insert_Expense_Data(G_DTExpenseData)
        Call GSub_CalculateExpense(GdtEQTrades, "EQ", True)
        'objTrad.Delete_Expense_Data_All()
        'objTrad.Insert_Expense_Data(G_DTExpenseData)
        Call GSub_CalculateExpense(GdtCurrencyTrades, "CURR", True)
        objTrad.Delete_Expense_Data_All()
        objTrad.Insert_Expense_Data(G_DTExpenseData)
        REM End
        Dim objAna As New analysisprocess
        Dim dtanalysis As DataTable = objAna.sel_analysis







        If dtanalysis.Select("IsVolFix='" & True & "'").Length > 0 Then
            For Each erow As DataRow In dtanalysis.Rows
                Dim str As String = erow("Script") + "_" + erow("Company")
                Dim Isvol As String = erow("IsVolFix")
                Dim vol As Double = erow("Vol")

                For Each erow1 As DataRow In dtable.Rows
                    Dim str1 As String = erow1("Script") + "_" + erow1("Company")
                    If (str = str1) Then
                        erow1("IsVolFix") = Isvol
                        erow1("lv") = vol
                        erow1("MktVol") = erow("MktVol")
                    End If

                Next

            Next

            dtable.AcceptChanges()
        End If


        Call fill_equity_dtable()
    End Sub

    Public Sub Update_isLiq(ByVal script As String, ByVal token1 As Long, ByVal isliq As Boolean, ByVal sCompname As String)

        data_access.ParamClear()
        data_access.AddParam("@isliq", OleDbType.Boolean, 15, isliq)
        data_access.AddParam("@token1", OleDbType.Integer, 18, token1)
        data_access.AddParam("@script", OleDbType.VarChar, 250, script)
        data_access.AddParam("@company", OleDbType.VarChar, 250, sCompname)
        data_access.Cmd_Text = sp_update_liq
        data_access.ExecuteNonQuery()

    End Sub
    Public Sub Update_Remarks(ByVal script As String, ByVal remarks As String, ByVal sCompname As String)

        data_access.ParamClear()
        data_access.AddParam("@remarks", OleDbType.VarChar, 250, remarks)
        data_access.AddParam("@script", OleDbType.VarChar, 250, script)
        data_access.AddParam("@company", OleDbType.VarChar, 250, sCompname)
        data_access.Cmd_Text = sp_update_remarks
        data_access.ExecuteNonQuery()

    End Sub
	''' <summary>
    ''' Update_IsVolFix is use to Update Is_VolFix Flag in Analysis Table in greek.mdb
    ''' call when grid CellEndEdit Event
    ''' by Viral
    ''' </summary>
    ''' <param name="script"></param>
    ''' <param name="IsVolFix"></param>
    ''' <remarks></remarks>
    Public Sub Update_IsVolFix(ByVal script As String, ByVal IsVolFix As Boolean, ByVal sCompname As String, ByVal VOL As Double)

        data_access.ParamClear()
        data_access.AddParam("@IsVolFix", OleDbType.Boolean, 18, IsVolFix)
        data_access.AddParam("@script", OleDbType.VarChar, 250, script)
        data_access.AddParam("@company", OleDbType.VarChar, 250, sCompname)

        data_access.Cmd_Text = sp_update_IsVolFix
        data_access.ExecuteNonQuery()

    End Sub

    ''' <summary>
    ''' Update_IsCalc is use to Update Is_Calc Flag in Analysis Table in greek.mdb
    ''' call when grid CellEndEdit Event
    ''' by Viral
    ''' </summary>
    ''' <param name="script"></param>
    ''' <param name="IsCalc"></param>
    ''' <remarks></remarks>
    Public Sub Update_IsCalc(ByVal script As String, ByVal IsCalc As Boolean, ByVal sCompname As String)

        data_access.ParamClear()
        data_access.AddParam("@IsCalc", OleDbType.Boolean, 15, IsCalc)
        data_access.AddParam("@script", OleDbType.VarChar, 250, script)
        data_access.AddParam("@company", OleDbType.VarChar, 250, sCompname)
        data_access.Cmd_Text = sp_update_IsCalc
        data_access.ExecuteNonQuery()

    End Sub
    '================================keval(17-2-10)--comment by NouseREM:payal(11-3-2016)
    'select asset token of the selected future token
    'Public Function Select_assetToken(ByVal token As Integer) As DataTable
    '    Try
    '        data_access.ParamClear()
    '        data_access.AddParam("@token", OleDbType.Integer, 8, token)
    '        data_access.Cmd_Text = SP_select_assetToken
    '        Return data_access.FillList()
    '    Catch ex As Exception
    '        MsgBox(ex.ToString)
    '        Return Nothing
    '    End Try
    'End Function
    Public Function ltp_token(ByVal tokanno As Long, ByVal script As String, ByVal sCompName As String) As Double
        dtanalysisData = sel_analysis()
        Dim noday As Integer
        If UCase(WeekdayName(Weekday(Now))) = "MONDAY" Then
            noday = 3
        Else
            noday = 1
        End If
        'Mrateofinterast = val(IIf(IsDBNull(objTrad.Settings.Compute("max(SettingKey)", "SettingName='Rateofinterest'")), 0, objTrad.Settings.Compute("max(SettingKey)", "SettingName='Rateofinterest'")))
        'bhavcopy = objBhav.select_data
        'GdtCompanyAnalysis = objTrad.select_company_ana
        ' DtAnalysis = sel_analysis()
        Dim edate As Date

        Try
            edate = dtanalysisData.Compute("Max(entrydate)", "")
        Catch ex As Exception
            edate = Now.Date
        End Try

        If noday = 1 And DateDiff(Microsoft.VisualBasic.DateInterval.Day, edate, Now.Date) > noday Then
            noday = DateDiff(Microsoft.VisualBasic.DateInterval.Day, edate, Now.Date)
        End If

        Dim chk As Boolean = False
        Dim chk1 As Boolean = False
        Dim futval As Double = 0
        Dim drdtanalysisData() As DataRow
        If dtanalysisData.Rows.Count > 0 Then


            drdtanalysisData = dtanalysisData.Select("entrydate='" & Now.Date & "'")

            'If dtanalysisData.Compute("count(tokanno)", "entrydate='" & Now.Date & "'") > 0 Then
            If drdtanalysisData.Length > 0 Then
                chk = True
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if today data exist in analysis table then get ltp
                ' and vol from that table
                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                drdtanalysisData = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")
                'If dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'").Length > 0 Then
                If drdtanalysisData.Length > 0 Then
                    futval = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")(0).Item("ltp").ToString()
                End If
                'For Each drow As DataRow In dtanalysis.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & "")
                '    futval = drow("ltp")
                'Next
            ElseIf dtanalysisData.Compute("count(tokanno)", "entrydate='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then

                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if today data does not exist then 
                ' chek for day befor data in analysis table 
                'if that data exist then get ltp
                ' and vol from that table

                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                chk = True
                chk1 = True
                drdtanalysisData = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")
                'If dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'").Length > 0 Then
                If drdtanalysisData.Length > 0 Then
                    futval = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")(0).Item("ltp").ToString()
                End If
                'For Each drow As DataRow In dtanalysis.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & "")
                '    futval = drow("ltp")
                'Next
                '=================================================================
                'ElseIf (True) Then
                '    chk = True
                '    '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""
                '    REM if today data exist in analysis table then get ltp
                '    ' and vol from that table
                '    '"""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                '    If dtanalysis.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'").Length > 0 Then
                '        futval = dtanalysis.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")(0).Item("ltp").ToString()
                '    End If
                '    'For Each drow As DataRow In dtanalysis.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & "")
                '    '    futval = drow("ltp")
                '    'Next
            Else

                chk = True
                chk1 = True
                drdtanalysisData = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")
                If drdtanalysisData.Length > 0 Then
                    futval = dtanalysisData.Select("script='" & script & "' and tokanno=" & CLng(tokanno) & " And company='" & sCompName & "'")(0).Item("ltp").ToString()
                End If
            End If
        End If

        If chk = True Then
            Dim drGdtBhavcopy() As DataRow
            drGdtBhavcopy = GdtBhavcopy.Select("entry_date='" & Now.Date & "'")

            'If chk1 = True And GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
            If chk1 = True And drGdtBhavcopy.Length > 0 Then
                '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                REM if ltp and vol get from anylysis table day before data then
                'check bhavcopy data for today date then get ltp from bhavcopy 
                'and calculate vol
                '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                chk = True
                drGdtBhavcopy = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")
                'If GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'").Length > 0 Then
                If drGdtBhavcopy.Length > 0 Then
                    futval = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")(0).Item("ltp")
                End If
                'For Each drow As DataRow In bhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")
                '    futval = drow("ltp")
                'Next
            ElseIf chk1 = True And GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
                chk = True
                drGdtBhavcopy = GdtBhavcopy.Select("script='" & script & "' and entry_date=#" & fDate(Now.Date) & "#")
                'If GdtBhavcopy.Select("script='" & script & "' and entry_date=#" & fDate(Now.Date) & "#").Length > 0 Then
                If drGdtBhavcopy.Length > 0 Then
                    futval = GdtBhavcopy.Select("script='" & script & "' and entry_date=#" & fDate(Now.Date) & "#")(0).Item("ltp").ToString()
                End If
                'For Each drow As DataRow In bhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                '    futval = drow("ltp")
                'Next
            ElseIf futval = 0 Then
                drGdtBhavcopy = GdtBhavcopy.Select("entry_date='" & Now.Date & "'")
                'If GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
                If drGdtBhavcopy.Length > 0 Then
                    '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                    REM if  analysis data does not exist for today and day before then
                    'check bhavcopy data for today date then get ltp from bhavcopy 
                    'and calculate vol
                    '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                    chk = True
                    drGdtBhavcopy = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")
                    'If GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'").Length > 0 Then
                    If drGdtBhavcopy.Length > 0 Then
                        futval = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")(0).Item("ltp").ToString()
                    End If
                    'For Each drow As DataRow In bhavcopy.Select("script='" & script & "'  and entry_date='" & Now.Date & "'")
                    '    futval = drow("ltp")
                    'Next
                ElseIf GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
                    '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
                    REM if  analysis data does not exist for today and day before then
                    'check bhavcopy data for today date then get ltp from bhavcopy 
                    'and calculate vol
                    '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
                    chk = True
                    drGdtBhavcopy = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                    'If GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'").Length > 0 Then
                    If drGdtBhavcopy.Length > 0 Then
                        futval = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")(0).Item("ltp").ToString()
                    End If
                    'For Each drow As DataRow In bhavcopy.Select("script='" & script & "'  and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
                    '    futval = drow("ltp")
                    'Next
                End If
            End If
        ElseIf chk = False And GdtBhavcopy.Compute("count(script)", "entry_date='" & Now.Date & "'") > 0 Then
            '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
            REM if  analysis data does not exist for today and day before then
            'check bhavcopy data for today date then get ltp from bhavcopy 
            'and calculate vol
            '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
            Dim drGdtBhavcopy1() As DataRow
            chk = True
            drGdtBhavcopy1 = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")
            'If GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'").Length > 0 Then
            If drGdtBhavcopy1.Length > 0 Then
                futval = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & Now.Date & "'")(0).Item("ltp").ToString()
            End If
            'For Each drow As DataRow In bhavcopy.Select("script='" & script & "'  and entry_date='" & Now.Date & "'")
            '    futval = drow("ltp")
            'Next
        ElseIf chk = False And GdtBhavcopy.Compute("count(script)", "entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'") > 0 Then
            '/*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
            REM if  analysis data does not exist for today and day before then
            'check bhavcopy data for today date then get ltp from bhavcopy 
            'and calculate vol
            '"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""*/
            chk = True
            Dim drGdtBhavcopy2() As DataRow
            drGdtBhavcopy2 = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
            'If GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'").Length > 0 Then
            If drGdtBhavcopy2.Length > 0 Then
                futval = GdtBhavcopy.Select("script='" & script & "' and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")(0).Item("ltp").ToString()
            End If
            'For Each drow As DataRow In bhavcopy.Select("script='" & script & "'  and entry_date='" & CDate(DateAdd(DateInterval.Day, -noday, Now.Date)) & "'")
            '    futval = drow("ltp")
            'Next
        End If
        Return futval

    End Function
    Public Function company_ltp(ByVal company As String) As String()
        'GdtCompanyAnalysis = objTrad.select_company_ana
        Dim arr(14) As String
        arr(0) = "0"
        arr(1) = "0"
        arr(2) = "0"
        arr(3) = "01/01/1905"
        arr(4) = "0"
        arr(5) = "01/01/1905"
        arr(6) = "0"
        arr(7) = "01/01/1905"
        arr(8) = "0"
        arr(9) = "0"
        arr(10) = "0"
        arr(11) = "0"
        arr(12) = "0"
        arr(13) = "0"
        Dim exp1 As Date = "01/01/1905"
        Dim drGdtCompanyAnalysis() As DataRow
        drGdtCompanyAnalysis = GdtCompanyAnalysis.Select("company='" & company & "' ")
        'For Each drow As DataRow In GdtCompanyAnalysis.Select("company='" & company & "' ")
        For Each drow As DataRow In drGdtCompanyAnalysis

            arr(0) = Val(drow("call_vol"))
            arr(1) = Val(drow("put_vol"))
            If CDate(exp1).Date <> CDate(drow("exp1")).Date Then
                arr(2) = Val(drow("fut1"))
                arr(3) = CDate(drow("exp1")).Date
            End If
            If CDate(exp1).Date <> CDate(drow("exp2")).Date Then
                arr(4) = Val(drow("fut2"))
                arr(5) = CDate(drow("exp2")).Date
            End If
            If CDate(exp1).Date <> CDate(drow("exp3")).Date Then
                arr(6) = Val(drow("fut3"))
                arr(7) = CDate(drow("exp3")).Date
            End If
            arr(8) = Val(drow("call_vol1"))
            arr(9) = Val(drow("put_vol1"))
            arr(10) = Val(drow("call_vol2"))
            arr(11) = Val(drow("put_vol2"))
            arr(12) = Val(drow("equity"))
            arr(13) = drow("equity_check")
        Next
        Return arr
    End Function
    Public Function get_AssetToken() As Integer
        Try
            data_access.ParamClear()
            data_access.Cmd_Text = SP_select_analysis
            data_access.FillList()

        Catch ex As Exception
            MsgBox(ex.ToString)
            Return Nothing
        End Try
    End Function
#End Region
End Class
